<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ระบบยืมอุปกรณ์</title>
  <style>
    body{
      font-family: "Sarabun", "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      margin:0;
      padding:20px;
      display:flex;
      flex-direction: column;
      align-items:center;
      min-height:100vh;
    }
    
    .container {
      width: 100%;
      max-width: 1400px;
      display: flex;
      flex-direction: column;
      gap: 30px;
    }
    
    .header {
      text-align: center;
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(33, 150, 243, 0.15);
      border: 2px solid #e3f2fd;
    }
    
    .logo-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    
    .logo {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      overflow: hidden;
      border: 3px solid #2196f3;
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
      background: #2196f3;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      font-weight: bold;
    }
    
    .header h1 {
      color: #1976d2;
      margin: 0;
      font-size: 28px;
    }
    
    .main-content {
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
    }
    
    .card{
      background:white;
      padding:25px;
      flex: 1;
      min-width: 350px;
      border-radius:16px;
      box-shadow:0 8px 30px rgba(33, 150, 243, 0.25);
      border: 2px solid #e3f2fd;
    }
    
    h2{ 
      margin-top:0; 
      color: #1976d2;
      text-align: center;
      font-weight: 600;
      margin-bottom: 24px;
      font-size: 22px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e3f2fd;
    }
    
    label{ 
      display:block; 
      margin-bottom:6px; 
      color: #1565c0;
      font-weight: 500;
      font-size: 14px;
    }
    
    input, select, textarea{
      width:100%;
      padding:12px;
      border:2px solid #e3f2fd;
      margin-bottom:16px;
      border-radius:10px;
      font-size: 15px;
      transition: all 0.3s ease;
      background-color: #f8fcff;
      box-sizing: border-box;
      font-family: "Sarabun", sans-serif;
    }
    
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    input:focus, select:focus, textarea:focus{
      outline: none;
      border-color: #2196f3;
      box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.2);
    }
    
    .row{ 
      display:flex; 
      gap:16px; 
      margin-bottom: 16px;
    }
    
    .row .col{ 
      flex:1; 
    }
    
    .table-card {
      background: white;
      padding: 25px;
      flex: 1.5;
      min-width: 350px;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(33, 150, 243, 0.25);
      border: 2px solid #e3f2fd;
      max-height: 700px;
      overflow-y: auto;
    }
    
    .status-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .refresh-btn {
      background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      font-family: "Sarabun", sans-serif;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .refresh-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }
    
    .refresh-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }
    
    .status-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 14px;
    }
    
    .status-table th {
      background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
      color: white;
      padding: 12px 10px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      white-space: nowrap;
    }
    
    .status-table td {
      padding: 12px 10px;
      border-bottom: 1px solid #e3f2fd;
      vertical-align: top;
    }
    
    .status-table tr:hover {
      background-color: #f5faff;
    }
    
    .status-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
      text-align: center;
      min-width: 70px;
    }
    
    .available {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .borrowed {
      background: #ffebee;
      color: #c62828;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
      font-size: 16px;
    }
    
    .primary-btn{
      background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
      color:white;
      border:0;
      padding:14px 20px;
      border-radius:10px;
      cursor:pointer;
      font-size:16px;
      font-weight:600;
      width: 100%;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
      font-family: "Sarabun", sans-serif;
    }
    
    .secondary-btn {
      background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
      color: white;
      border: 0;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.3s ease;
      font-family: "Sarabun", sans-serif;
      white-space: nowrap;
    }
    
    .danger-btn {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
      color: white;
      border: 0;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.3s ease;
      font-family: "Sarabun", sans-serif;
      white-space: nowrap;
    }
    
    .primary-btn:hover:not([disabled]){
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(33, 150, 243, 0.4);
    }
    
    .secondary-btn:hover:not([disabled]) {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3);
    }
    
    .danger-btn:hover:not([disabled]) {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(244, 67, 54, 0.3);
    }
    
    button[disabled]{ 
      opacity:.7; 
      cursor:not-allowed;
      transform: none;
    }
    
    .msg{
      margin-top:16px;
      padding:12px;
      border-radius:10px;
      font-size:14px;
      text-align: center;
      font-weight: 500;
      display: none;
    }
    
    .msg.success{ 
      background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
      color:#2e7d32; 
      border: 2px solid #81c784;
    }
    
    .msg.error{ 
      background: linear-gradient(135deg, #ffcdd2 0%, #ef9a9a 100%);
      color:#c62828; 
      border: 2px solid #e57373;
    }
    
    .msg.info {
      background: linear-gradient(135deg, #bbdefb 0%, #90caf9 100%);
      color:#1565c0; 
      border: 2px solid #64b5f6;
    }
    
    .tabs {
      display: flex;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .tab {
      flex: 1;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      font-weight: 600;
      color: #666;
      background: #f5f5f5;
      transition: all 0.3s ease;
      font-family: "Sarabun", sans-serif;
      font-size: 14px;
    }
    
    .tab.active {
      background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
      color: white;
    }
    
    .tab:hover:not(.active) {
      background: #e0e0e0;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .summary-cards {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .summary-card {
      flex: 1;
      background: white;
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      min-width: 120px;
    }
    
    .summary-card h3 {
      margin: 0 0 8px 0;
      color: #555;
      font-size: 13px;
      font-weight: 500;
    }
    
    .summary-card .number {
      font-size: 28px;
      font-weight: bold;
      color: #1976d2;
    }
    
    .footer {
      text-align: center;
      margin-top: 20px;
      color: #666;
      font-size: 13px;
      padding: 15px;
      background: white;
      border-radius: 12px;
      width: 100%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
    }
    
    .modal-content {
      background: white;
      padding: 25px;
      border-radius: 16px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 25px;
    }
    
    .modal-buttons button {
      flex: 1;
      padding: 12px;
      font-size: 14px;
    }
    
    .action-buttons {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }
    
    .search-box {
      margin-bottom: 15px;
    }
    
    .search-box input {
      margin-bottom: 0;
      padding: 10px 12px;
      padding-left: 40px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23666' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 12px center;
      background-size: 16px;
    }
    
    .no-data {
      text-align: center;
      padding: 40px 20px;
      color: #666;
      font-size: 15px;
    }
    
    .chip {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      margin: 2px;
    }
    
    .chip-warning {
      background: #fff3e0;
      color: #ef6c00;
    }
    
    .chip-danger {
      background: #ffebee;
      color: #c62828;
    }
    
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .main-content {
        flex-direction: column;
        gap: 20px;
      }
      
      .card, .table-card {
        min-width: 100%;
        padding: 20px;
      }
      
      .row {
        flex-direction: column;
        gap: 0;
      }
      
      .summary-cards {
        flex-direction: column;
      }
      
      .status-header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .refresh-btn {
        align-self: flex-start;
      }
      
      .status-table {
        display: block;
        overflow-x: auto;
      }
      
      .modal-content {
        padding: 20px;
      }
      
      .tab {
        padding: 12px 10px;
        font-size: 13px;
      }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>

  <div class="container">
    <div class="header">
      <div class="logo-container">
        <div class="logo">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
            <path d="M19 5V19H5V5H19ZM19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM14 17H7V15H14V17ZM17 13H7V11H17V13ZM17 9H7V7H17V9Z"/>
          </svg>
        </div>
        <div>
          <h1>ระบบยืมอุปกรณ์</h1>
          <p>Equipment Borrowing System</p>
        </div>
      </div>
    </div>

    <div class="main-content">
      <div class="card">
        <h2>ฟอร์มยืมอุปกรณ์</h2>

        <form id="borrowForm">
          <div id="formMsg" class="msg info"></div>
          
          <label>รหัสพนักงาน *</label>
          <input type="text" id="empCode" required placeholder="เช่น EMP001, IT001">

          <label>ชื่อ - นามสกุล *</label>
          <input type="text" id="fullName" required placeholder="กรุณากรอกชื่อ-นามสกุลเต็ม">

          <label>แผนก *</label>
          <select id="department" required>
            <option value="" disabled selected>-- เลือกแผนก --</option>
            <option value="IT">แผนก IT</option>
            <option value="HR">แผนก HR</option>
            <option value="Marketing">แผนกการตลาด</option>
            <option value="Sales">แผนกขาย</option>
            <option value="Finance">แผนกการเงิน</option>
            <option value="Operations">แผนกปฏิบัติการ</option>
            <option value="Other">อื่นๆ</option>
          </select>

          <label>อุปกรณ์ที่ต้องการยืม *</label>
          <select id="item" required>
            <option value="" disabled selected>-- เลือกอุปกรณ์ --</option>
            <!-- Options will be loaded from Google Sheets -->
          </select>

          <div class="row">
            <div class="col">
              <label>วันที่ยืม *</label>
              <input type="date" id="fromDate" required>
            </div>
            <div class="col">
              <label>วันที่คืน *</label>
              <input type="date" id="toDate" required>
            </div>
          </div>

          <label>วัตถุประสงค์การยืม *</label>
          <select id="purpose" required>
            <option value="" disabled selected>-- เลือกวัตถุประสงค์ --</option>
            <option value="meeting">ใช้ในการประชุม</option>
            <option value="presentation">ใช้ในการนำเสนอ</option>
            <option value="event">ใช้ในงานอีเวนต์</option>
            <option value="training">ใช้ในการฝึกอบรม</option>
            <option value="work">ใช้ในการทำงาน</option>
            <option value="other">อื่นๆ</option>
          </select>

          <label>หมายเหตุเพิ่มเติม</label>
          <textarea id="remark" placeholder="รายละเอียดเพิ่มเติม (ถ้ามี)"></textarea>

          <button type="submit" class="primary-btn" id="btnSend">
            <span id="btnText">บันทึกข้อมูลการยืม</span>
            <span id="btnLoading" style="display:none;">กำลังบันทึก...</span>
          </button>

          <div id="msgSuccess" class="msg success"></div>
          <div id="msgError" class="msg error"></div>
        </form>
      </div>

      <div class="table-card">
        <div class="status-header">
          <h2>สถานะการยืมอุปกรณ์</h2>
          <button class="refresh-btn" id="btnRefresh">
            <svg id="refreshIcon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
              <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
            </svg>
            <span id="refreshText">รีเฟรช</span>
            <span id="loadingText" style="display:none;">กำลังโหลด...</span>
          </button>
        </div>

        <div class="summary-cards">
          <div class="summary-card">
            <h3>อุปกรณ์ทั้งหมด</h3>
            <div class="number" id="totalItems">0</div>
          </div>
          <div class="summary-card">
            <h3>ถูกยืมอยู่</h3>
            <div class="number" id="borrowedItems">0</div>
          </div>
          <div class="summary-card">
            <h3>ว่าง</h3>
            <div class="number" id="availableItems">0</div>
          </div>
        </div>

        <div class="tabs">
          <div class="tab active" data-tab="current">กำลังยืมอยู่</div>
          <div class="tab" data-tab="equipment">รายการอุปกรณ์</div>
          <div class="tab" data-tab="history">ประวัติการยืม</div>
        </div>

        <div class="search-box" style="display: none;" id="searchContainer">
          <input type="text" id="searchInput" placeholder="ค้นหาอุปกรณ์หรือชื่อผู้ยืม...">
        </div>

        <div id="currentTab" class="tab-content active">
          <table class="status-table">
            <thead>
              <tr>
                <th>อุปกรณ์</th>
                <th>ผู้ยืม</th>
                <th>วันที่ยืม</th>
                <th>วันที่คืน</th>
                <th>สถานะ</th>
                <th>การดำเนินการ</th>
              </tr>
            </thead>
            <tbody id="currentTableBody">
              <tr><td colspan="6" class="loading">กำลังโหลดข้อมูลจาก Google Sheets...</td></tr>
            </tbody>
          </table>
        </div>

        <div id="equipmentTab" class="tab-content">
          <table class="status-table">
            <thead>
              <tr>
                <th>รหัสอุปกรณ์</th>
                <th>ชื่ออุปกรณ์</th>
                <th>ประเภท</th>
                <th>ผู้รับผิดชอบ</th>
                <th>สถานะ</th>
              </tr>
            </thead>
            <tbody id="equipmentTableBody">
              <tr><td colspan="5" class="loading">กำลังโหลดข้อมูลจาก Google Sheets...</td></tr>
            </tbody>
          </table>
        </div>

        <div id="historyTab" class="tab-content">
          <table class="status-table">
            <thead>
              <tr>
                <th>วันที่ยืม</th>
                <th>อุปกรณ์</th>
                <th>ผู้ยืม</th>
                <th>วันที่คืน</th>
                <th>สถานะ</th>
              </tr>
            </thead>
            <tbody id="historyTableBody">
              <tr><td colspan="5" class="loading">กำลังโหลดข้อมูลจาก Google Sheets...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="footer">
      <div>© <span id="currentYear"></span> ระบบจัดการยืมอุปกรณ์</div>
      <div>เชื่อมต่อกับ Google Sheets | อัปเดตล่าสุด: <span id="lastUpdate">-</span></div>
    </div>
  </div>

  <!-- Modal สำหรับยืนยันการคืนอุปกรณ์ -->
  <div id="returnModal" class="modal">
    <div class="modal-content">
      <h3 style="margin-top: 0; color: #1976d2;">ยืนยันการคืนอุปกรณ์</h3>
      <p>คุณต้องการคืนอุปกรณ์ <strong id="modalItemName"></strong> ใช่หรือไม่?</p>
      <div class="modal-buttons">
        <button class="danger-btn" id="confirmReturn">คืนอุปกรณ์</button>
        <button class="secondary-btn" id="cancelReturn">ยกเลิก</button>
      </div>
    </div>
  </div>

  <script>
    // ===================== CONFIGURATION =====================
    // ใส่ URL ของ Google Apps Script ของคุณที่นี่
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx5QVE2M9YynSlCbK0EPmzftoX12c6Qy4wiUDjpLpcgCa9poPsR5ROHVCZi0u-xDqK6/exec";
    
    // ===================== GLOBAL VARIABLES =====================
    let equipmentData = [];
    let borrowingsData = [];
    let selectedReturnId = null;
    
    // ===================== DOM ELEMENTS =====================
    const elements = {
      form: document.getElementById("borrowForm"),
      btnSend: document.getElementById("btnSend"),
      btnText: document.getElementById("btnText"),
      btnLoading: document.getElementById("btnLoading"),
      btnRefresh: document.getElementById("btnRefresh"),
      refreshIcon: document.getElementById("refreshIcon"),
      refreshText: document.getElementById("refreshText"),
      loadingText: document.getElementById("loadingText"),
      
      // Message elements
      formMsg: document.getElementById("formMsg"),
      successBox: document.getElementById("msgSuccess"),
      errorBox: document.getElementById("msgError"),
      
      // Table bodies
      currentTableBody: document.getElementById("currentTableBody"),
      equipmentTableBody: document.getElementById("equipmentTableBody"),
      historyTableBody: document.getElementById("historyTableBody"),
      
      // Summary elements
      totalItems: document.getElementById("totalItems"),
      borrowedItems: document.getElementById("borrowedItems"),
      availableItems: document.getElementById("availableItems"),
      
      // Other elements
      lastUpdate: document.getElementById("lastUpdate"),
      currentYear: document.getElementById("currentYear"),
      searchContainer: document.getElementById("searchContainer"),
      searchInput: document.getElementById("searchInput"),
      itemSelect: document.getElementById("item"),
      
      // Modal elements
      returnModal: document.getElementById("returnModal"),
      modalItemName: document.getElementById("modalItemName"),
      confirmReturnBtn: document.getElementById("confirmReturn"),
      cancelReturnBtn: document.getElementById("cancelReturn")
    };
    
    // ===================== INITIALIZATION =====================
    document.addEventListener('DOMContentLoaded', function() {
      init();
    });
    
    function init() {
      // Set current year in footer
      elements.currentYear.textContent = new Date().getFullYear();
      
      // Set default dates
      setDefaultDates();
      
      // Set up event listeners
      setupEventListeners();
      
      // Set up tabs
      setupTabs();
      
      // Load initial data from Google Sheets
      loadDataFromGoogleSheets();
    }
    
    function setDefaultDates() {
      const today = new Date();
      const tomorrow = new Date(today);
      tomorrow.setDate(today.getDate() + 1);
      
      // Format dates for input fields
      const formatDateForInput = (date) => {
        return date.toISOString().split('T')[0];
      };
      
      document.getElementById("fromDate").value = formatDateForInput(today);
      document.getElementById("toDate").value = formatDateForInput(tomorrow);
      
      // Set min dates
      document.getElementById("fromDate").min = formatDateForInput(today);
      document.getElementById("toDate").min = formatDateForInput(today);
    }
    
    function setupEventListeners() {
      // Form submission
      elements.form.addEventListener("submit", handleFormSubmit);
      
      // Refresh button
      elements.btnRefresh.addEventListener("click", loadDataFromGoogleSheets);
      
      // Date validation
      document.getElementById("fromDate").addEventListener("change", validateDates);
      document.getElementById("toDate").addEventListener("change", validateDates);
      
      // Modal events
      elements.confirmReturnBtn.addEventListener("click", handleReturnConfirm);
      elements.cancelReturnBtn.addEventListener("click", closeReturnModal);
      
      // Close modals when clicking outside
      window.addEventListener("click", (e) => {
        if (e.target === elements.returnModal) closeReturnModal();
      });
      
      // Search functionality
      elements.searchInput.addEventListener("input", handleSearch);
    }
    
    function setupTabs() {
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.getAttribute('data-tab');
          
          // Update active tab
          tabs.forEach(t => t.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
          
          tab.classList.add('active');
          document.getElementById(`${tabId}Tab`).classList.add('active');
          
          // Show/hide search box
          if (tabId === 'current' || tabId === 'history') {
            elements.searchContainer.style.display = 'block';
          } else {
            elements.searchContainer.style.display = 'none';
            elements.searchInput.value = '';
          }
          
          // Refresh table data
          refreshTableData(tabId);
        });
      });
    }
    
    // ===================== GOOGLE SHEETS INTEGRATION =====================
    async function loadDataFromGoogleSheets() {
      try {
        // Show loading state
        elements.refreshText.style.display = 'none';
        elements.loadingText.style.display = 'inline';
        elements.refreshIcon.style.transform = 'rotate(360deg)';
        elements.btnRefresh.disabled = true;
        
        // Load equipment data
        await loadEquipmentFromSheets();
        
        // Load borrowings data
        await loadBorrowingsFromSheets();
        
        // Update all displays
        updateAllDisplays();
        
        // Update timestamp
        updateLastUpdateTime();
        
        // Show success message
        showMessage('success', 'โหลดข้อมูลจาก Google Sheets เรียบร้อยแล้ว', 2000);
        
      } catch (error) {
        console.error('Error loading data from Google Sheets:', error);
        showMessage('error', 'ไม่สามารถโหลดข้อมูลจาก Google Sheets ได้: ' + error.message);
      } finally {
        // Restore button state
        elements.refreshText.style.display = 'inline';
        elements.loadingText.style.display = 'none';
        elements.refreshIcon.style.transform = 'rotate(0deg)';
        elements.btnRefresh.disabled = false;
      }
    }
    
    async function loadEquipmentFromSheets() {
      try {
        const response = await fetch(`${WEB_APP_URL}?action=getEquipment`);
        const result = await response.json();
        
        if (result.success) {
          equipmentData = result.data || [];
          populateEquipmentDropdown();
        } else {
          throw new Error(result.error || 'Failed to load equipment data');
        }
      } catch (error) {
        console.error('Error loading equipment:', error);
        throw error;
      }
    }
    
    async function loadBorrowingsFromSheets() {
      try {
        const response = await fetch(`${WEB_APP_URL}?action=getBorrowings`);
        const result = await response.json();
        
        if (result.success) {
          borrowingsData = result.data || [];
        } else {
          throw new Error(result.error || 'Failed to load borrowings data');
        }
      } catch (error) {
        console.error('Error loading borrowings:', error);
        throw error;
      }
    }
    
    async function submitToGoogleSheets(data, action) {
      try {
        const response = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({
            action: action,
            data: JSON.stringify(data)
          })
        });
        
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.error || 'Failed to submit data');
        }
        
        return result;
      } catch (error) {
        console.error('Error submitting to Google Sheets:', error);
        throw error;
      }
    }
    
    // ===================== DISPLAY FUNCTIONS =====================
    function updateAllDisplays() {
      updateSummary();
      refreshTableData('current');
      refreshTableData('equipment');
      refreshTableData('history');
    }
    
    function updateSummary() {
      if (!equipmentData || equipmentData.length === 0) {
        elements.totalItems.textContent = "0";
        elements.borrowedItems.textContent = "0";
        elements.availableItems.textContent = "0";
        return;
      }
      
      const total = equipmentData.length;
      const borrowed = equipmentData.filter(item => 
        item.status === 'borrowed' || item.status === 'ถูกยืม' || item.status === 'กำลังยืม'
      ).length;
      const available = total - borrowed;
      
      elements.totalItems.textContent = total;
      elements.borrowedItems.textContent = borrowed;
      elements.availableItems.textContent = available;
    }
    
    function refreshTableData(tabId) {
      switch(tabId) {
        case 'current':
          displayCurrentBorrowings();
          break;
        case 'equipment':
          displayEquipment();
          break;
        case 'history':
          displayHistory();
          break;
      }
    }
    
    function displayCurrentBorrowings() {
      const currentBorrowings = borrowingsData.filter(item => 
        item.status === 'กำลังยืม' || item.status === 'borrowed'
      );
      
      if (!currentBorrowings || currentBorrowings.length === 0) {
        elements.currentTableBody.innerHTML = `
          <tr>
            <td colspan="6" class="no-data">
              <div>ไม่มีอุปกรณ์ที่กำลังถูกยืมอยู่ในขณะนี้</div>
            </td>
          </tr>
        `;
        return;
      }
      
      const searchTerm = elements.searchInput.value.toLowerCase();
      const filteredData = currentBorrowings.filter(item => {
        if (!searchTerm) return true;
        return (
          (item.equipmentName || item.item || '').toLowerCase().includes(searchTerm) ||
          (item.fullName || '').toLowerCase().includes(searchTerm) ||
          (item.empCode || '').toLowerCase().includes(searchTerm)
        );
      });
      
      if (filteredData.length === 0) {
        elements.currentTableBody.innerHTML = `
          <tr>
            <td colspan="6" class="no-data">
              <div>ไม่พบข้อมูลที่ตรงกับการค้นหา</div>
            </td>
          </tr>
        `;
        return;
      }
      
      let html = '';
      filteredData.forEach(item => {
        const equipmentName = item.equipmentName || item.item || 'ไม่ระบุ';
        const equipmentId = item.equipmentId || item.itemId || '';
        const fullName = item.fullName || 'ไม่ระบุ';
        const empCode = item.empCode || '';
        const department = item.department || '';
        const fromDate = item.fromDate || item.borrowedDate || '';
        const toDate = item.toDate || item.returnDate || '';
        
        html += `
          <tr>
            <td>
              <strong>${equipmentName}</strong>
              ${equipmentId ? `<div style="font-size: 12px; color: #666;">${equipmentId}</div>` : ''}
            </td>
            <td>
              <div>${fullName}</div>
              ${empCode ? `<div style="font-size: 12px; color: #666;">${empCode} ${department ? `(${department})` : ''}</div>` : ''}
            </td>
            <td>${formatDateForDisplay(fromDate)}</td>
            <td>${formatDateForDisplay(toDate)}</td>
            <td><span class="status-badge borrowed">กำลังยืม</span></td>
            <td class="action-buttons">
              <button class="danger-btn" onclick="openReturnModal('${item.id || item._id}', '${equipmentName}', '${fullName}')">
                คืนอุปกรณ์
              </button>
            </td>
          </tr>
        `;
      });
      
      elements.currentTableBody.innerHTML = html;
    }
    
    function displayEquipment() {
      if (!equipmentData || equipmentData.length === 0) {
        elements.equipmentTableBody.innerHTML = `
          <tr>
            <td colspan="5" class="no-data">
              <div>ยังไม่มีข้อมูลอุปกรณ์ในระบบ</div>
            </td>
          </tr>
        `;
        return;
      }
      
      let html = '';
      equipmentData.forEach(item => {
        const id = item.id || item._id || '';
        const name = item.name || item.itemName || 'ไม่ระบุ';
        const type = item.type || item.category || 'ไม่ระบุ';
        const responsible = item.responsible || item.responsiblePerson || 'ไม่ระบุ';
        const status = item.status || 'ว่าง';
        
        let statusThai, statusClass;
        if (status === 'ว่าง' || status === 'available') {
          statusThai = 'ว่าง';
          statusClass = 'available';
        } else if (status === 'ถูกยืม' || status === 'borrowed' || status === 'กำลังยืม') {
          statusThai = 'ถูกยืม';
          statusClass = 'borrowed';
        } else {
          statusThai = status;
          statusClass = 'available';
        }
        
        html += `
          <tr>
            <td><strong>${id}</strong></td>
            <td>${name}</td>
            <td>${type}</td>
            <td>${responsible}</td>
            <td><span class="status-badge ${statusClass}">${statusThai}</span></td>
          </tr>
        `;
      });
      
      elements.equipmentTableBody.innerHTML = html;
    }
    
    function displayHistory() {
      const historyBorrowings = borrowingsData.filter(item => 
        item.status === 'คืนแล้ว' || item.status === 'returned'
      );
      
      if (historyBorrowings.length === 0) {
        elements.historyTableBody.innerHTML = `
          <tr>
            <td colspan="5" class="no-data">
              <div>ไม่มีประวัติการยืม</div>
            </td>
          </tr>
        `;
        return;
      }
      
      const searchTerm = elements.searchInput.value.toLowerCase();
      const filteredData = historyBorrowings.filter(item => {
        if (!searchTerm) return true;
        return (
          (item.equipmentName || item.item || '').toLowerCase().includes(searchTerm) ||
          (item.fullName || '').toLowerCase().includes(searchTerm) ||
          (item.empCode || '').toLowerCase().includes(searchTerm)
        );
      });
      
      if (filteredData.length === 0) {
        elements.historyTableBody.innerHTML = `
          <tr>
            <td colspan="5" class="no-data">
              <div>ไม่พบข้อมูลที่ตรงกับการค้นหา</div>
            </td>
          </tr>
        `;
        return;
      }
      
      // Sort by date descending
      filteredData.sort((a, b) => {
        const dateA = new Date(a.borrowedDate || a.fromDate || '');
        const dateB = new Date(b.borrowedDate || b.fromDate || '');
        return dateB - dateA;
      });
      
      let html = '';
      filteredData.forEach(item => {
        const equipmentName = item.equipmentName || item.item || 'ไม่ระบุ';
        const equipmentId = item.equipmentId || item.itemId || '';
        const fullName = item.fullName || 'ไม่ระบุ';
        const empCode = item.empCode || '';
        const borrowedDate = item.borrowedDate || item.fromDate || '';
        const returnDate = item.returnDate || item.toDate || '';
        
        html += `
          <tr>
            <td>${formatDateForDisplay(borrowedDate)}</td>
            <td>
              <div>${equipmentName}</div>
              ${equipmentId ? `<div style="font-size: 12px; color: #666;">${equipmentId}</div>` : ''}
            </td>
            <td>
              <div>${fullName}</div>
              ${empCode ? `<div style="font-size: 12px; color: #666;">${empCode}</div>` : ''}
            </td>
            <td>${formatDateForDisplay(returnDate)}</td>
            <td><span class="status-badge available">คืนแล้ว</span></td>
          </tr>
        `;
      });
      
      elements.historyTableBody.innerHTML = html;
    }
    
    function populateEquipmentDropdown() {
      elements.itemSelect.innerHTML = '<option value="" disabled selected>-- เลือกอุปกรณ์ --</option>';
      
      const availableEquipment = equipmentData.filter(item => 
        item.status === 'available' || item.status === 'ว่าง'
      );
      
      if (availableEquipment.length === 0) {
        elements.itemSelect.innerHTML += '<option value="" disabled>ไม่มีอุปกรณ์ว่างในขณะนี้</option>';
        return;
      }
      
      availableEquipment.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id || item._id;
        option.textContent = `${item.name || item.itemName} (${item.id || item._id})`;
        elements.itemSelect.appendChild(option);
      });
      
      // Add "other" option
      const otherOption = document.createElement('option');
      otherOption.value = 'other';
      otherOption.textContent = 'อื่นๆ (ระบุในหมายเหตุ)';
      elements.itemSelect.appendChild(otherOption);
    }
    
    // ===================== UTILITY FUNCTIONS =====================
    function formatDateForDisplay(dateString) {
      if (!dateString) return '-';
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString('th-TH', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      } catch (e) {
        return dateString;
      }
    }
    
    function updateLastUpdateTime() {
      const now = new Date();
      elements.lastUpdate.textContent = now.toLocaleString('th-TH', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    function showMessage(type, message, duration = 5000) {
      // Hide all messages first
      elements.formMsg.style.display = 'none';
      elements.successBox.style.display = 'none';
      elements.errorBox.style.display = 'none';
      
      let targetElement;
      switch(type) {
        case 'success':
          targetElement = elements.successBox;
          break;
        case 'error':
          targetElement = elements.errorBox;
          break;
        case 'info':
          targetElement = elements.formMsg;
          break;
        default:
          return;
      }
      
      targetElement.textContent = message;
      targetElement.style.display = 'block';
      
      if (duration > 0) {
        setTimeout(() => {
          targetElement.style.display = 'none';
        }, duration);
      }
    }
    
    // ===================== FORM HANDLING =====================
    function validateDates() {
      const fromDate = new Date(document.getElementById("fromDate").value);
      const toDate = new Date(document.getElementById("toDate").value);
      
      if (toDate < fromDate) {
        showMessage('error', 'วันที่คืนต้องไม่น้อยกว่าวันที่ยืม');
        document.getElementById("toDate").value = document.getElementById("fromDate").value;
        return false;
      }
      
      return true;
    }
    
    async function handleFormSubmit(e) {
      e.preventDefault();
      
      // Validate form
      if (!validateForm()) {
        return;
      }
      
      // Show loading state
      setButtonLoading(true);
      
      try {
        // Prepare data for Google Sheets
        const formData = getFormDataForSheets();
        
        // Submit to Google Sheets
        await submitToGoogleSheets(formData, 'createBorrowing');
        
        // Reload data from Google Sheets
        await loadDataFromGoogleSheets();
        
        // Reset form
        resetForm();
        
        // Show success message
        showMessage('success', 'บันทึกการยืมอุปกรณ์เรียบร้อยแล้ว');
        
      } catch (error) {
        console.error('Error submitting form:', error);
        showMessage('error', 'เกิดข้อผิดพลาดในการบันทึกข้อมูล: ' + error.message);
      } finally {
        setButtonLoading(false);
      }
    }
    
    function validateForm() {
      const requiredFields = ['empCode', 'fullName', 'department', 'item', 'fromDate', 'toDate', 'purpose'];
      
      for (const fieldId of requiredFields) {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
          showMessage('error', `กรุณากรอกข้อมูลในช่อง: ${field.previousElementSibling.textContent}`);
          field.focus();
          return false;
        }
      }
      
      if (!validateDates()) {
        return false;
      }
      
      // Check if equipment is available
      const selectedEquipmentId = elements.itemSelect.value;
      if (selectedEquipmentId !== 'other') {
        const equipment = equipmentData.find(item => 
          (item.id === selectedEquipmentId || item._id === selectedEquipmentId)
        );
        if (!equipment || (equipment.status !== 'available' && equipment.status !== 'ว่าง')) {
          showMessage('error', 'อุปกรณ์ที่เลือกไม่ว่างในขณะนี้');
          return false;
        }
      }
      
      return true;
    }
    
    function getFormDataForSheets() {
      const selectedEquipmentId = elements.itemSelect.value;
      let equipmentName = '';
      let equipmentId = selectedEquipmentId;
      
      if (selectedEquipmentId === 'other') {
        equipmentName = document.getElementById("remark").value.split('\n')[0] || 'อุปกรณ์อื่นๆ';
        equipmentId = 'EQ-OTHER-' + Date.now().toString().slice(-6);
      } else {
        const equipment = equipmentData.find(item => 
          item.id === selectedEquipmentId || item._id === selectedEquipmentId
        );
        equipmentName = equipment ? (equipment.name || equipment.itemName) : 'ไม่ทราบชื่ออุปกรณ์';
      }
      
      return {
        id: 'BR' + Date.now().toString().slice(-8),
        equipmentId: equipmentId,
        equipmentName: equipmentName,
        empCode: document.getElementById("empCode").value.trim(),
        fullName: document.getElementById("fullName").value.trim(),
        department: document.getElementById("department").value,
        fromDate: document.getElementById("fromDate").value,
        toDate: document.getElementById("toDate").value,
        purpose: document.getElementById("purpose").value,
        remark: document.getElementById("remark").value.trim(),
        status: 'กำลังยืม',
        borrowedDate: new Date().toISOString().split('T')[0],
        returnDate: null,
        submittedAt: new Date().toISOString()
      };
    }
    
    function resetForm() {
      elements.form.reset();
      setDefaultDates();
      populateEquipmentDropdown();
    }
    
    function setButtonLoading(loading) {
      if (loading) {
        elements.btnText.style.display = 'none';
        elements.btnLoading.style.display = 'inline';
        elements.btnSend.disabled = true;
      } else {
        elements.btnText.style.display = 'inline';
        elements.btnLoading.style.display = 'none';
        elements.btnSend.disabled = false;
      }
    }
    
    // ===================== RETURN HANDLING =====================
    function openReturnModal(recordId, itemName, borrowerName) {
      selectedReturnId = recordId;
      elements.modalItemName.textContent = itemName;
      elements.returnModal.style.display = 'flex';
    }
    
    function closeReturnModal() {
      elements.returnModal.style.display = 'none';
      selectedReturnId = null;
    }
    
    async function handleReturnConfirm() {
      if (!selectedReturnId) return;
      
      try {
        // Find the borrowing record
        const borrowing = borrowingsData.find(item => 
          item.id === selectedReturnId || item._id === selectedReturnId
        );
        
        if (!borrowing) {
          showMessage('error', 'ไม่พบข้อมูลการยืม');
          return;
        }
        
        // Prepare return data for Google Sheets
        const returnData = {
          borrowingId: borrowing.id || borrowing._id,
          equipmentId: borrowing.equipmentId || borrowing.itemId,
          returnDate: new Date().toISOString().split('T')[0],
          status: 'คืนแล้ว'
        };
        
        // Submit return to Google Sheets
        await submitToGoogleSheets(returnData, 'returnEquipment');
        
        // Reload data from Google Sheets
        await loadDataFromGoogleSheets();
        
        // Show success message
        showMessage('success', `คืนอุปกรณ์ ${borrowing.equipmentName || borrowing.item} เรียบร้อยแล้ว`);
        
        // Close modal
        closeReturnModal();
        
      } catch (error) {
        console.error('Error returning equipment:', error);
        showMessage('error', 'เกิดข้อผิดพลาดในการคืนอุปกรณ์: ' + error.message);
      }
    }
    
    // ===================== SEARCH FUNCTIONALITY =====================
    function handleSearch() {
      const activeTab = document.querySelector('.tab.active');
      if (activeTab) {
        const tabId = activeTab.getAttribute('data-tab');
        refreshTableData(tabId);
      }
    }
    
    // ===================== GLOBAL FUNCTIONS =====================
    // Make functions available globally for onclick attributes
    window.openReturnModal = openReturnModal;
    
  </script>
</body>
</html>