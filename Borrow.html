<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ระบบยืมอุปกรณ์</title>
  <style>
    body{
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      margin:0;
      padding:20px;
      display:flex;
      flex-direction: column;
      align-items:center;
      min-height:100vh;
    }
    
    .container {
      width: 100%;
      max-width: 1200px;
      display: flex;
      flex-direction: column;
      gap: 30px;
    }
    
    .header {
      text-align: center;
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(33, 150, 243, 0.15);
      border: 2px solid #e3f2fd;
    }
    
    .logo-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .logo {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      overflow: hidden;
      border: 3px solid #2196f3;
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
    }
    
    .logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .header h1 {
      color: #1976d2;
      margin: 0;
      font-size: 28px;
    }
    
    .main-content {
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
    }
    
    .card{
      background:white;
      padding:30px;
      flex: 1;
      min-width: 400px;
      border-radius:16px;
      box-shadow:0 8px 30px rgba(33, 150, 243, 0.25);
      border: 2px solid #e3f2fd;
    }
    
    h2{ 
      margin-top:0; 
      color: #1976d2;
      text-align: center;
      font-weight: 600;
      margin-bottom: 24px;
      font-size: 22px;
    }
    
    label{ 
      display:block; 
      margin-bottom:8px; 
      color: #1565c0;
      font-weight: 500;
      font-size: 14px;
    }
    
    input, select{
      width:100%;
      padding:12px;
      border:2px solid #e3f2fd;
      margin-bottom:16px;
      border-radius:10px;
      font-size: 15px;
      transition: all 0.3s ease;
      background-color: #f8fcff;
    }
    
    input:focus, select:focus{
      outline: none;
      border-color: #2196f3;
      box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.2);
    }
    
    .row{ 
      display:flex; 
      gap:16px; 
      margin-bottom: 16px;
    }
    
    .row .col{ 
      flex:1; 
    }
    
    .table-card {
      background: white;
      padding: 30px;
      flex: 1;
      min-width: 400px;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(33, 150, 243, 0.25);
      border: 2px solid #e3f2fd;
      max-height: 600px;
      overflow-y: auto;
    }
    
    .status-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .refresh-btn {
      background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .refresh-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }
    
    .status-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    
    .status-table th {
      background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
      color: white;
      padding: 12px 15px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
    }
    
    .status-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #e3f2fd;
    }
    
    .status-table tr:hover {
      background-color: #f5faff;
    }
    
    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }
    
    .available {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .borrowed {
      background: #ffebee;
      color: #c62828;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    
    button{
      background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
      color:white;
      border:0;
      padding:12px 20px;
      border-radius:10px;
      cursor:pointer;
      font-size:16px;
      font-weight:600;
      width: 100%;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
    }
    
    button:hover:not([disabled]){
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(33, 150, 243, 0.4);
    }
    
    button[disabled]{ 
      opacity:.7; 
      cursor:not-allowed;
      transform: none;
    }
    
    .msg{
      margin-top:16px;
      padding:12px;
      border-radius:10px;
      display:none;
      font-size:14px;
      text-align: center;
      font-weight: 500;
    }
    
    .msg.success{ 
      background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
      color:#2e7d32; 
      border: 2px solid #81c784;
    }
    
    .msg.error{ 
      background: linear-gradient(135deg, #ffcdd2 0%, #ef9a9a 100%);
      color:#c62828; 
      border: 2px solid #e57373;
    }
    
    .tabs {
      display: flex;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .tab {
      flex: 1;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      font-weight: 600;
      color: #666;
      background: #f5f5f5;
      transition: all 0.3s ease;
    }
    
    .tab.active {
      background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
      color: white;
    }
    
    .tab:hover:not(.active) {
      background: #e0e0e0;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .summary-cards {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .summary-card {
      flex: 1;
      background: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .summary-card h3 {
      margin: 0 0 10px 0;
      color: #555;
      font-size: 14px;
    }
    
    .summary-card .number {
      font-size: 32px;
      font-weight: bold;
      color: #1976d2;
    }
    
    .footer {
      text-align: center;
      margin-top: 20px;
      color: #666;
      font-size: 14px;
    }
  </style>
</head>
<body>

  <div class="container">
    <div class="header">
      <div class="logo-container">
        <div class="logo">
          <img src="Gemini_Generated_Image_xb5d3exb5d3exb5d-Photoroom.png" alt="Logo">
        </div>
        <h1>ระบบยืมอุปกรณ์</h1>
      </div>
    </div>

    <div class="main-content">
      <div class="card">
        <h2>ฟอร์มยืมอุปกรณ์</h2>

        <form id="borrowForm">
          <label>รหัสพนักงาน</label>
          <input type="text" id="empCode" required placeholder="เช่น EMP001">

          <label>ชื่อ - นามสกุล</label>
          <input type="text" id="fullName" required placeholder="เช่น สมชาย ใจดี">

          <label>อุปกรณ์ที่ต้องการยืม</label>
          <select id="item" required>
            <option value="" disabled selected>-- กรุณาเลือกอุปกรณ์ --</option>
            <option value="Notebook">Notebook</option>
            <option value="ลำโพง">ลำโพง</option>
            <option value="เครื่องปริ้น">เครื่องปริ้น</option>
            <option value="Projector">Projector</option>
            <option value="Camera">Camera</option>
            <option value="Tablet">Tablet</option>
            <option value="อื่นๆ">อื่นๆ</option>
          </select>

          <div class="row">
            <div class="col">
              <label>ยืมจากวันที่</label>
              <input type="date" id="fromDate" required>
            </div>
            <div class="col">
              <label>ยืมถึงวันที่</label>
              <input type="date" id="toDate" required>
            </div>
          </div>

          <label>หมายเหตุ (ไม่บังคับ)</label>
          <input type="text" id="remark" placeholder="ใส่รายละเอียดเพิ่มเติม">

          <button type="submit" id="btnSend">บันทึกข้อมูลการยืม</button>

          <div id="msgSuccess" class="msg success">บันทึกข้อมูลเรียบร้อย ✓</div>
          <div id="msgError" class="msg error"></div>
        </form>
      </div>

      <div class="table-card">
        <div class="status-header">
          <h2>สถานะการยืมอุปกรณ์</h2>
          <button class="refresh-btn" id="btnRefresh">
            <span id="refreshText">รีเฟรช</span>
            <span id="loadingText" style="display:none;">กำลังโหลด...</span>
          </button>
        </div>

        <div class="summary-cards">
          <div class="summary-card">
            <h3>อุปกรณ์ทั้งหมด</h3>
            <div class="number" id="totalItems">0</div>
          </div>
          <div class="summary-card">
            <h3>ถูกยืมอยู่</h3>
            <div class="number" id="borrowedItems">0</div>
          </div>
          <div class="summary-card">
            <h3>ว่าง</h3>
            <div class="number" id="availableItems">0</div>
          </div>
        </div>

        <div class="tabs">
          <div class="tab active" data-tab="current">กำลังยืมอยู่</div>
          <div class="tab" data-tab="all">รายการทั้งหมด</div>
        </div>

        <div id="currentTab" class="tab-content active">
          <table class="status-table">
            <thead>
              <tr>
                <th>อุปกรณ์</th>
                <th>ผู้ยืม</th>
                <th>วันที่ยืม</th>
                <th>วันที่คืน</th>
                <th>สถานะ</th>
              </tr>
            </thead>
            <tbody id="currentTableBody">
            </tbody>
          </table>
          <div id="currentLoading" class="loading">กำลังโหลดข้อมูล...</div>
        </div>

        <div id="allTab" class="tab-content">
          <table class="status-table">
            <thead>
              <tr>
                <th>อุปกรณ์</th>
                <th>รหัส</th>
                <th>ผู้รับผิดชอบ</th>
                <th>สถานะ</th>
                <th>หมายเหตุ</th>
              </tr>
            </thead>
            <tbody id="allTableBody">
            </tbody>
          </table>
          <div id="allLoading" class="loading">กำลังโหลดข้อมูล...</div>
        </div>
      </div>
    </div>

    <div class="footer">
      © 2023 ระบบจัดการยืมอุปกรณ์ | อัปเดตล่าสุด: <span id="lastUpdate">-</span>
    </div>
  </div>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx5QVE2M9YynSlCbK0EPmzftoX12c6Qy4wiUDjpLpcgCa9poPsR5ROHVCZi0u-xDqK6/exec";
    
    let borrowingData = [];
    let equipmentData = [];
    
    const form = document.getElementById("borrowForm");
    const btn = document.getElementById("btnSend");
    const btnRefresh = document.getElementById("btnRefresh");
    const successBox = document.getElementById("msgSuccess");
    const errorBox = document.getElementById("msgError");
    const currentTableBody = document.getElementById("currentTableBody");
    const allTableBody = document.getElementById("allTableBody");
    const currentLoading = document.getElementById("currentLoading");
    const allLoading = document.getElementById("allLoading");
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const refreshText = document.getElementById('refreshText');
    const loadingText = document.getElementById('loadingText');
    const lastUpdate = document.getElementById('lastUpdate');
    
    document.getElementById("fromDate").valueAsDate = new Date();
    const today = new Date();
    const nextWeek = new Date(today);
    nextWeek.setDate(today.getDate() + 3);
    document.getElementById("toDate").valueAsDate = nextWeek;
    
    function showSuccess(msg){
      errorBox.style.display = "none";
      successBox.innerText = msg;
      successBox.style.display = "block";
      setTimeout(()=> successBox.style.display="none", 3000);
    }
    
    function showError(msg){
      successBox.style.display = "none";
      errorBox.innerText = msg;
      errorBox.style.display = "block";
      setTimeout(()=> errorBox.style.display="none", 5000);
    }
    
    function showLoading(show) {
      if (show) {
        refreshText.style.display = "none";
        loadingText.style.display = "inline";
        btnRefresh.disabled = true;
      } else {
        refreshText.style.display = "inline";
        loadingText.style.display = "none";
        btnRefresh.disabled = false;
      }
    }
    
    async function fetchBorrowingsData() {
      try {
        const response = await fetch(`${WEB_APP_URL}?action=getBorrowings`);
        const result = await response.json();
        
        if (result.success) {
          borrowingData = result.data.filter(item => {
            const status = item.Status || item.status;
            return status === "กำลังยืม" || status === "active" || !status;
          });
          return borrowingData;
        } else {
          throw new Error(result.error || "ไม่สามารถดึงข้อมูลได้");
        }
      } catch (error) {
        console.error("Error fetching borrowings:", error);
        return [];
      }
    }
    
    async function fetchEquipmentData() {
      try {
        const response = await fetch(`${WEB_APP_URL}?action=getEquipment`);
        const result = await response.json();
        
        if (result.success) {
          equipmentData = result.data;
          return equipmentData;
        } else {
          throw new Error(result.error || "ไม่สามารถดึงข้อมูลได้");
        }
      } catch (error) {
        console.error("Error fetching equipment:", error);
        return [];
      }
    }
    
    async function refreshData() {
      showLoading(true);
      
      try {
        const [borrowings, equipment] = await Promise.all([
          fetchBorrowingsData(),
          fetchEquipmentData()
        ]);
        
        displayCurrentBorrowings();
        displayAllItems();
        updateSummary();
        
        const now = new Date();
        lastUpdate.textContent = now.toLocaleString('th-TH', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        if (borrowings.length === 0 && equipment.length === 0) {
          showError("ยังไม่มีข้อมูลในระบบ");
        } else {
          showSuccess("อัปเดตข้อมูลเรียบร้อย ✓");
        }
        
      } catch (error) {
        console.error("Error refreshing data:", error);
        showError("เกิดข้อผิดพลาดในการดึงข้อมูล");
      } finally {
        showLoading(false);
      }
    }
    
    function displayCurrentBorrowings() {
      currentLoading.style.display = "none";
      
      if (!borrowingData || borrowingData.length === 0) {
        currentTableBody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; padding: 30px; color: #666;">
              ไม่มีอุปกรณ์ที่กำลังถูกยืมอยู่ในขณะนี้
            </td>
          </tr>
        `;
        return;
      }
      
      let html = '';
      borrowingData.forEach(record => {
        const itemName = record.Item || record.item || "ไม่ระบุ";
        const fullName = record.FullName || record.fullName || "ไม่ระบุ";
        const empCode = record.EmpCode || record.empCode || "ไม่ระบุ";
        const fromDate = record.FromDate || record.fromDate;
        const toDate = record.ToDate || record.toDate;
        
        let itemId = '-';
        let itemNote = '';
        
        if (equipmentData.length > 0) {
          const itemInfo = equipmentData.find(e => {
            const eqName = e['ชื่ออุปกรณ์'] || e.name || '';
            const eqType = e.ประเภท || e.type || '';
            return eqType === itemName || eqName.includes(itemName);
          });
          
          if (itemInfo) {
            itemId = itemInfo.ID || itemInfo.id || '-';
            itemNote = itemInfo.หมายเหตุ || itemInfo.note || '';
          }
        }
        
        html += `
          <tr>
            <td>
              <strong>${itemName}</strong>
              ${itemId !== '-' ? `<br><small>รหัส: ${itemId}</small>` : ''}
              ${itemNote ? `<br><small>${itemNote}</small>` : ''}
            </td>
            <td>${fullName}<br><small>รหัส: ${empCode}</small></td>
            <td>${formatDate(fromDate)}</td>
            <td>${formatDate(toDate)}</td>
            <td><span class="status-badge borrowed">กำลังยืม</span></td>
          </tr>
        `;
      });
      
      currentTableBody.innerHTML = html;
    }
    
    function displayAllItems() {
      allLoading.style.display = "none";
      
      if (!equipmentData || equipmentData.length === 0) {
        allTableBody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; padding: 30px; color: #666;">
              ยังไม่มีข้อมูลอุปกรณ์ในระบบ
            </td>
          </tr>
        `;
        return;
      }
      
      let html = '';
      equipmentData.forEach(item => {
        const name = item['ชื่ออุปกรณ์'] || item.name || "ไม่ระบุชื่อ";
        const id = item.ID || item.id || "-";
        const responsible = item['ผู้รับผิดชอบ'] || item.responsible || "-";
        const note = item.หมายเหตุ || item.note || "";
        
        const status = item.สถานะ || item.status || "ว่าง";
        let statusThai, statusClass;
        
        if (status === "ว่าง" || status === "available" || status === "") {
          statusThai = "ว่าง";
          statusClass = "available";
        } else if (status === "ถูกยืม" || status === "borrowed" || status === "กำลังยืม") {
          statusThai = "ถูกยืม";
          statusClass = "borrowed";
        } else {
          statusThai = status;
          statusClass = "available";
        }
        
        html += `
          <tr>
            <td><strong>${name}</strong></td>
            <td>${id}</td>
            <td>${responsible}</td>
            <td>
              <span class="status-badge ${statusClass}">
                ${statusThai}
              </span>
            </td>
            <td><small>${note}</small></td>
          </tr>
        `;
      });
      
      allTableBody.innerHTML = html;
    }
    
    function updateSummary() {
      if (!equipmentData || equipmentData.length === 0) {
        document.getElementById("totalItems").textContent = "0";
        document.getElementById("borrowedItems").textContent = "0";
        document.getElementById("availableItems").textContent = "0";
        return;
      }
      
      const total = equipmentData.length;
      let borrowed = 0;
      let available = 0;
      
      equipmentData.forEach(item => {
        const status = item.สถานะ || item.status || "";
        if (status === "ถูกยืม" || status === "borrowed" || status === "กำลังยืม") {
          borrowed++;
        } else if (status === "ว่าง" || status === "available" || status === "") {
          available++;
        }
      });
      
      document.getElementById("totalItems").textContent = total;
      document.getElementById("borrowedItems").textContent = borrowed;
      document.getElementById("availableItems").textContent = available;
    }
    
    function formatDate(dateString) {
      if (!dateString) return '-';
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString('th-TH', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      } catch (e) {
        return dateString;
      }
    }
    
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.getAttribute('data-tab');
        
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        
        tab.classList.add('active');
        document.getElementById(`${tabId}Tab`).classList.add('active');
      });
    });
    
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
    
      const empCode  = document.getElementById("empCode").value.trim();
      const fullName = document.getElementById("fullName").value.trim();
      const item     = document.getElementById("item").value;
      const fromDate = document.getElementById("fromDate").value;
      const toDate   = document.getElementById("toDate").value;
      const remark   = document.getElementById("remark").value.trim();
    
      if(!item) {
        showError("กรุณาเลือกอุปกรณ์ที่ต้องการยืม");
        return;
      }
    
      if(new Date(toDate) < new Date(fromDate)){
        showError("วันที่สิ้นสุดต้องไม่น้อยกว่าวันที่เริ่มต้น");
        return;
      }
    
      const payload = {
        empCode, 
        fullName, 
        item,
        fromDate, 
        toDate, 
        remark,
        timestamp: new Date().toISOString()
      };
    
      btn.disabled = true;
      btn.innerText = "กำลังส่ง...";
    
      try {
        await fetch(WEB_APP_URL, {
          method: "POST",
          mode: "no-cors",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });
    
        showSuccess("บันทึกข้อมูลการยืมเรียบร้อย ✓");
        form.reset();
        
        document.getElementById("fromDate").valueAsDate = new Date();
        const newNextWeek = new Date();
        newNextWeek.setDate(newNextWeek.getDate() + 3);
        document.getElementById("toDate").valueAsDate = newNextWeek;
        
        setTimeout(() => {
          refreshData();
        }, 1000);
    
      } catch (err) {
        showError("เกิดข้อผิดพลาด: " + err.message);
      } finally {
        btn.disabled = false;
        btn.innerText = "บันทึกข้อมูลการยืม";
      }
    });
    
    btnRefresh.addEventListener("click", refreshData);
    
    document.addEventListener("DOMContentLoaded", () => {
      refreshData();
    });
  </script>

</body>
</html>