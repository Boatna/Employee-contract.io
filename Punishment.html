<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>บันทึกการลงโทษทางวินัย → สร้าง PDF</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
body, .a4 {
  font-family: 'Sarabun', sans-serif;
}
body {
  font-weight: 400;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  background-color: #f0f9ff;
  font-size: 18px;
  line-height: 1.6;
}
.a4 {
  width: 210mm;
  min-height: 297mm;
  padding: 15mm;
  background: #fff;
  box-shadow: 0 0 15px rgba(0,0,0,0.1);
  margin: 20px auto;
  box-sizing: border-box;
  border-radius: 8px;
  font-size: 14px;
  line-height: 1.6;
  position: relative;
}
.contract-content {
  font-size: 14px;
  line-height: 1.6;
  color: #000;
  font-family: 'Sarabun', sans-serif;
}
.contract-content p,
.letter-paragraph {
  margin: 0.5rem 0;
  text-align: justify;
}
.official-checkbox-label {
  display: inline-flex;
  align-items: flex-start;
  cursor: pointer;
  font-size: 14px;
  color: #0f172a;
}
.form-group { margin-bottom: 1rem; }
.label { 
  display: block; 
  font-size: 18px;
  font-weight: 600; 
  margin-bottom: 0.5rem;
  color: #1e293b;
}
.input {
  width: 100%;
  border: 1px solid #cbd5e1;
  border-radius: 0.5rem;
  padding: 0.75rem 1rem;
  font-size: 18px;
  transition: all 0.3s ease;
  font-family: 'Sarabun', sans-serif;
}
.input:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
}
.btn {
  padding: 0.75rem 1.5rem;
  border-radius: 0.5rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 18px;
  border: none;
  font-family: 'Sarabun', sans-serif;
}
.btn-primary {
  background: linear-gradient(to right, #2563eb, #4f46e5);
  color: white;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.btn-primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.btn-secondary {
  background: linear-gradient(to right, #475569, #1e293b);
  color: white;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.btn-secondary:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.btn-danger {
  background: linear-gradient(to right, #dc2626, #b91c1c);
  color: white;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.btn-danger:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.section-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: #0f172a;
  margin-bottom: 1.5rem;
  border-bottom: 2px solid #dbeafe;
  padding-bottom: 0.5rem;
  display: flex;
  align-items: center;
}
.section-title svg {
  margin-right: 0.5rem;
}
.contract-preview {
  background: white;
  border-radius: 0.5rem;
  border: 1px solid #e2e8f0;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.clause {
  margin-top: 0.5rem;
  text-align: justify;
  line-height: 1.8;
}
.clause-number {
  font-weight: 600;
  color: #000000;
}
.signature-box {
  height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  border: 2px dashed #94a3b8;
  border-radius: 0.5rem;
  background-color: #f1f5f9;
  color: #64748b;
  font-style: italic;
  transition: all 0.3s ease;
}
.signature-box.has-signature {
  border: 2px solid #1e40af;
  background-color: #eff6ff;
  color: #1e3a8a;
}
.signature-box img {
  max-height: 60px;
  max-width: 180px;
  object-fit: contain;
  filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
}
@page {
  size: A4;
  margin: 0;
}
@media print {
  body {
    background-color: #fff;
  }
  .container {
    max-width: none;
    padding: 0;
  }
  .card:first-child {
    display: none;
  }
  .a4 {
    width: 210mm;
    height: 297mm;
    margin: 0 !important;
    box-shadow: none;
    font-family: 'Sarabun', sans-serif;
    padding: 15mm;
    box-sizing: border-box;
  }
  .contract-content {
    font-size: 14px;
    line-height: 1.6;
  }
  .btn-group, .section-title, .form-container {
    display: none;
  }
  .signature-box-print.has-signature {
    border-bottom: 1px solid #000 !important;
  }
  .signature-box-print.has-signature img {
    display: block !important;
    max-height: 50px;
    margin: 0 auto;
  }
  .government-letter {
    font-size: 14px;
  }
  .letter-date {
    font-size: 14px;
  }
  .letter-paragraph {
    margin: 0.5rem 0;
    font-size: 14px;
  }
  .letter-section-title {
    font-size: 1.1rem;
  }
  .letter-list-item {
    font-size: 14px;
  }
  .signature-label {
    font-size: 14px;
  }
  .signature-name {
    font-size: 14px;
  }
  .signature-date {
    font-size: 12px;
  }
  .official-advice-title {
    font-size: 1.1rem;
  }
  .official-advice-item {
    font-size: 12px;
  }
}
.grid-4 {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr 1fr;
  gap: 0.5rem;
}
.form-container {
  background-color: #f0f9ff;
  padding: 1.5rem;
  border-radius: 0.75rem;
  border: 1px solid #bae6fd;
}
.form-section {
  margin-bottom: 1.5rem;
  padding: 1.5rem;
  background-color: white;
  border-radius: 0.75rem;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border: 1px solid #e0f2fe;
}
.form-section-title {
  font-size: 1.25rem;
  font-weight: 600;
  color: #0369a1;
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid #bae6fd;
}
.signature-section {
  margin-top: 1.5rem;
}
.signature-section-title {
  font-size: 1.25rem;
  font-weight: 600;
  color: #0369a1;
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid #bae6fd;
}
.signature-pad-container {
  border: 1px solid #bae6fd;
  border-radius: 0.5rem;
  padding: 0.75rem;
  background-color: #f0f9ff;
  transition: box-shadow 0.3s ease;
}
.signature-pad-container:hover {
  box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
}
.signature-pad {
  border: 1px solid #cbd5e1;
  border-radius: 0.375rem;
  background-color: white;
  width: 100%;
  height: 150px;
}
.signature-controls {
  display: flex;
  gap: 0.5rem;
  margin-top: 0.5rem;
}
.signature-btn {
  padding: 0.5rem 1rem;
  border-radius: 0.375rem;
  font-size: 0.875rem;
  cursor: pointer;
  border: 1px solid #cbd5e1;
  transition: all 0.3s ease;
  font-family: 'Sarabun', sans-serif;
}
.signature-btn.clear {
  background-color: #fee2e2;
  color: #dc2626;
}
.signature-btn.clear:hover {
  background-color: #fecaca;
}
.signature-btn.save {
  background-color: #bbf7d0;
  color: #166534;
}
.signature-btn.save:hover {
  background-color: #86efac;
}
.signature-status {
  margin-top: 0.5rem;
  font-size: 0.875rem;
  color: #64748b;
  text-align: center;
  font-style: italic;
}
.signature-status.signed {
  color: #16a34a;
  font-weight: 600;
  font-style: normal;
}
.note-box {
  background-color: #fffbeb;
  border: 1px solid #fde68a;
  border-radius: 0.5rem;
  padding: 1rem;
  margin: 1rem 0;
}
.btn-group {
  display: flex;
  gap: 1rem;
  margin-top: 1.5rem;
  flex-wrap: wrap;
}
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 1rem;
  border-radius: 0.5rem;
  background-color: #16a34a;
  color: white;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  transform: translateX(100%);
  transition: transform 0.3s ease;
  z-index: 1000;
  font-family: 'Sarabun', sans-serif;
  font-size: 18px;
}
.notification.show {
  transform: translateX(0);
}
.notification.error {
  background-color: #dc2626;
}
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}
.official-checkbox-label {
  display: inline-flex;
  align-items: flex-start;
  cursor: pointer;
  font-size: 18px;
  color: #0f172a;
}
.official-checkbox-indicator {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid #000;
  margin-right: 8px;
  flex-shrink: 0;
  position: relative;
  background-color: white;
  transition: background-color 0.2s ease;
  box-sizing: border-box;
}
.official-checkbox-label:hover .official-checkbox-indicator {
  background-color: #f8fafc;
}
.sr-only:checked + .official-checkbox-label .official-checkbox-indicator::after {
  content: "";
  display: block;
  width: 100%;
  height: 100%;
  background-color: #000;
  position: absolute;
  top: 0;
  left: 0;
  padding: 0;
  margin: 0;
  box-sizing: border-box;
  border-radius: 2px;
}
@media print {
  .sr-only:checked + .official-checkbox-label .official-checkbox-indicator {
    border: 2px solid #000;
    background-color: #fff;
  }
  .sr-only:checked + .official-checkbox-label .official-checkbox-indicator::after {
    content: "" !important;
    display: block !important;
    background-color: #000 !important;
    border-radius: 2px;
  }
}
.punishment-item-label {
  display: flex;
  align-items: flex-start;
  font-size: 14px;
  line-height: 1.5;
  min-height: 24px;
}
.punishment-item-label .official-checkbox-indicator {
  margin-top: 2px;
}
.government-letter {
  min-height: 100%;
  font-size: 14px;
}
.letter-header {
  text-align: center;
  margin-bottom: 1.5rem;
}
.letter-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: #0f172a;
  text-decoration: underline;
  text-underline-offset: 4px;
  text-decoration-thickness: 2px;
}
.letter-date {
  text-align: right;
  font-weight: 600;
  color: #0f172a;
  margin-bottom: 1.5rem;
  font-size: 14px;
}
.letter-paragraph {
  margin: 0.5rem 0;
  line-height: 1.6;
  font-size: 14px;
  text-align: justify;
}
.letter-section {
  margin: 1rem 0;
}
.letter-section-title {
  font-weight: 700;
  color: #0f172a;
  margin-bottom: 0.6rem;
  font-size: 1.1rem;
}
.letter-list {
  margin-top: 0.6rem;
}
.letter-list-item {
  margin-bottom: 0.4rem;
  line-height: 1.5;
  font-size: 14px;
}
.letter-signature-section {
  margin-top: 1.8rem;
}
.signature-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.8rem;
  margin-top: 1rem;
}
.signature-item {
  text-align: center;
}
.signature-label {
  margin-top: 0.4rem;
  font-weight: 600;
  font-size: 14px;
}
.signature-name {
  margin-top: 0.2rem;
  font-size: 14px;
  color: #000;
  font-weight: 500;
  text-align: center;
}
.signature-date {
  margin-top: 0.2rem;
  font-size: 12px;
  color: #64748b;
}
.official-advice {
  margin-top: 1.8rem;
  padding-top: 0.8rem;
  border-top: 1px solid #e2e8f0;
}
.official-advice-title {
  font-weight: 700;
  color: #0f172a;
  margin-bottom: 0.6rem;
  font-size: 1.1rem;
}
.advice-list {
  margin-top: 0.6rem;
}
.official-advice-item {
  margin-bottom: 0.4rem;
  line-height: 1.5;
  font-size: 12px;
}
.signature-box-print {
  min-height: 80px;
  border-bottom: 1px solid #000;
  margin-top: 2rem;
  text-align: center;
  padding-top: 0.5rem;
  display: flex;
  justify-content: center;
  align-items: center;
}
.signature-box-print.has-signature {
  border-bottom: 1px solid #000;
}
.spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid #ffffff;
  border-radius: 50%;
  border-top-color: transparent;
  animation: spin 1s ease-in-out infinite;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
.header-bg {
  background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
  color: white;
  padding: 2rem 0;
  margin-bottom: 2rem;
  border-radius: 0 0 1rem 1rem;
}
.header-title {
  font-size: 2rem;
  font-weight: 700;
  text-align: center;
  text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.card {
  background: white;
  border-radius: 1rem;
  box-shadow: 0 4px 6px rgba(0,0,0,0.05);
  padding: 1.5rem;
  margin-bottom: 2rem;
  border: 1px solid #e0f2fe;
}
.signature-tutorial {
  background-color: #f0f9ff;
  border: 1px solid #7dd3fc;
  border-radius: 0.5rem;
  padding: 1rem;
  margin-top: 1rem;
}
.signature-tutorial-title {
  font-weight: 600;
  color: #0369a1;
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
}
.signature-tutorial-title svg {
  margin-right: 0.5rem;
}
.signature-tutorial-list {
  list-style-type: disc;
  padding-left: 1.5rem;
}
.signature-tutorial-item {
  margin-bottom: 0.5rem;
  font-size: 14px;
  color: #334155;
}
.signature-quality-notice {
  background-color: #fffbeb;
  border: 1px solid #fde68a;
  border-radius: 0.375rem;
  padding: 0.5rem;
  margin-top: 0.5rem;
  font-size: 0.75rem;
  color: #92400e;
}
</style>
</head>
<body>
<div class="header-bg">
  <div class="container mx-auto px-4">
    <h1 class="header-title">ระบบบันทึกการลงโทษทางวินัย</h1>
  </div>
</div>
<div class="container mx-auto px-4 py-8">
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <div class="card">
      <h2 class="section-title">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
        ข้อมูลการลงโทษ
      </h2>
      <form id="contractForm" class="form-container" onsubmit="return false;">
        <div class="form-section">
          <h3 class="form-section-title">ข้อมูลพื้นฐาน</h3>
          <div class="grid grid-cols-1 gap-4">
            <div class="input-group">
              <label for="doc_date" class="label">วันที่</label>
              <input id="doc_date" type="date" class="input" required>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="input-group">
                <label for="employee_name" class="label">ชื่อ-สกุล</label>
                <input id="employee_name" placeholder="กรอกชื่อ-สกุล" class="input" required>
              </div>
              <div class="input-group">
                <label for="employee_code" class="label">รหัสพนักงาน</label>
                <input id="employee_code" placeholder="กรอกรหัสพนักงาน" class="input" required>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="input-group">
                <label for="position" class="label">ตำแหน่ง</label>
                <input id="position" placeholder="กรอกตำแหน่ง" class="input" required>
              </div>
              <div class="input-group">
                <label for="department" class="label">หน่วยงาน</label>
                <input id="department" placeholder="กรอกหน่วยงาน" class="input" required>
              </div>
            </div>
            <div class="input-group">
              <label for="division" class="label">ฝ่าย</label>
              <input id="division" placeholder="กรอกฝ่าย" class="input" required>
            </div>
          </div>
        </div>
        <div class="form-section">
          <h3 class="form-section-title">รายละเอียดการกระทำผิด</h3>
          <div class="grid grid-cols-1 gap-4">
            <div class="input-group">
              <label class="label">หมวด/ข้อ/วงเล็บ/หน้า</label>
              <div class="grid-4">
                <input id="rule_section" placeholder="หมวด" class="input">
                <input id="rule_clause" placeholder="ข้อ" class="input">
                <input id="rule_parentheses" placeholder="วงเล็บ" class="input">
                <input id="rule_page" placeholder="หน้า" class="input">
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="input-group">
                <label for="place" class="label">สถานที่</label>
                <input id="place" placeholder="กรอกสถานที่" class="input" required>
              </div>
              <div class="input-group">
                <label for="offense_date" class="label">วันที่กระทำผิด</label>
                <input id="offense_date" type="date" class="input" required>
              </div>
            </div>
            <div class="input-group">
              <label for="offense_description" class="label">หมวดวินัยและโทษทางวินัย</label>
              <textarea id="offense_description" placeholder="กรอกรายละเอียดหมวดวินัย..." class="input h-24" required></textarea>
            </div>
          </div>
        </div>
        <div class="form-section">
          <h3 class="form-section-title">ประเภทการลงโทษ</h3>
          <div class="grid grid-cols-1 gap-4">
            <div class="input-group">
              <label for="punishment_type" class="label">ประเภทการลงโทษ</label>
              <select id="punishment_type" class="input" required>
                <option value="">-- เลือกประเภทการลงโทษ --</option>
                <option value="เตือนด้วยวาจาบันทึกเป็นหนังสือ">เตือนด้วยวาจาบันทึกเป็นหนังสือ</option>
                <option value="เตือนเป็นลายลักษณ์อักษร">เตือนเป็นลายลักษณ์อักษร</option>
                <option value="ตัดโบนัส/ไม่ปรับเงินประจำปี">ตัดโบนัส/ไม่ปรับเงินประจำปี</option>
                <option value="พักงาน">พักงาน</option>
                <option value="เลิกจ้าง">เลิกจ้าง</option>
              </select>
            </div>
            <div id="suspensionDetails" class="space-y-3 p-4 bg-blue-50 rounded border border-blue-200 hidden">
              <h4 class="font-semibold mb-2 text-lg">รายละเอียดการพักงาน</h4>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="input-group">
                  <label for="suspension_days" class="label">จำนวนวัน</label>
                  <input id="suspension_days" type="number" min="1" max="7" placeholder="1-7" class="input" required>
                </div>
                <div class="input-group">
                  <label for="suspension_start" class="label">เริ่มวันที่</label>
                  <input id="suspension_start" type="date" class="input" required>
                </div>
                <div class="input-group">
                  <label for="suspension_end" class="label">ถึงวันที่</label>
                  <input id="suspension_end" type="date" class="input" required>
                </div>
              </div>
            </div>
            <div id="terminationDetails" class="space-y-3 p-4 bg-blue-50 rounded border border-blue-200 hidden">
              <h4 class="font-semibold mb-2 text-lg">รายละเอียดการเลิกจ้าง</h4>
              <div class="input-group">
                <label for="termination_date" class="label">มีผลตั้งแต่</label>
                <input id="termination_date" type="date" class="input" required>
              </div>
            </div>
            <div class="input-group">
              <label for="punishment_detail" class="label">คำแนะนำ</label>
              <textarea id="punishment_detail" placeholder="กรอกคำแนะนำเพิ่มเติม..." class="input h-20"></textarea>
            </div>
          </div>
        </div>
        <div class="form-section">
          <h3 class="form-section-title">ลายเซ็น</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div class="input-group">
              <label for="supervisor_name" class="label">ชื่อหัวหน้างาน</label>
              <input id="supervisor_name" placeholder="กรอกชื่อหัวหน้างาน" class="input">
            </div>
            <div class="input-group">
              <label for="manager_name" class="label">ชื่อผู้จัดการฝ่าย</label>
              <input id="manager_name" placeholder="กรอกชื่อผู้จัดการฝ่าย" class="input">
            </div>
            <div class="input-group">
              <label for="hr_name" class="label">ชื่อผู้จัดการฝ่าย HR</label>
              <input id="hr_name" placeholder="กรอกชื่อผู้จัดการฝ่าย HR" class="input">
            </div>
          </div>
          <div class="signature-tutorial">
            <div class="signature-tutorial-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
              </svg>
              คำแนะนำการใช้งานลายเซ็น
            </div>
            <ul class="signature-tutorial-list">
              <li class="signature-tutorial-item">ลากเมาส์หรือใช้นิ้วลากเพื่อเซ็นชื่อในกล่องสีขาว</li>
              <li class="signature-tutorial-item">กดปุ่ม "บันทึก" เพื่อบันทึกลายเซ็น</li>
              <li class="signature-tutorial-item">กดปุ่ม "ล้าง" เพื่อลบล้างและเซ็นใหม่</li>
              <li class="signature-tutorial-item">กรุณาเซ็นชื่อให้ครบทั้ง 4 ช่องก่อนดาวน์โหลด PDF</li>
            </ul>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
            <div>
              <label class="label">ลายเซ็นหัวหน้างาน</label>
              <div class="signature-pad-container" id="supervisor_signature_container">
                <canvas id="supervisor_signature_pad" class="signature-pad"></canvas>
                <div class="signature-controls">
                  <button type="button" id="clear_supervisor" class="signature-btn clear">ล้าง</button>
                  <button type="button" id="save_supervisor" class="signature-btn save">บันทึก</button>
                </div>
                <div class="signature-status" id="supervisor_status">กรุณาเซ็นชื่อที่นี่</div>
                <div class="signature-quality-notice">เซ็นชื่อให้มีขนาดใหญ่และชัดเจน</div>
              </div>
            </div>
            <div>
              <label class="label">ลายเซ็นผู้จัดการฝ่าย</label>
              <div class="signature-pad-container" id="manager_signature_container">
                <canvas id="manager_signature_pad" class="signature-pad"></canvas>
                <div class="signature-controls">
                  <button type="button" id="clear_manager" class="signature-btn clear">ล้าง</button>
                  <button type="button" id="save_manager" class="signature-btn save">บันทึก</button>
                </div>
                <div class="signature-status" id="manager_status">กรุณาเซ็นชื่อที่นี่</div>
                <div class="signature-quality-notice">เซ็นชื่อให้มีขนาดใหญ่และชัดเจน</div>
              </div>
            </div>
            <div>
              <label class="label">ลายเซ็นพนักงาน</label>
              <div class="signature-pad-container" id="employee_signature_container">
                <canvas id="employee_signature_pad" class="signature-pad"></canvas>
                <div class="signature-controls">
                  <button type="button" id="clear_employee" class="signature-btn clear">ล้าง</button>
                  <button type="button" id="save_employee" class="signature-btn save">บันทึก</button>
                </div>
                <div class="signature-status" id="employee_status">กรุณาเซ็นชื่อที่นี่</div>
                <div class="signature-quality-notice">เซ็นชื่อให้มีขนาดใหญ่และชัดเจน</div>
              </div>
            </div>
            <div>
              <label class="label">ลายเซ็นผู้จัดการฝ่าย HR</label>
              <div class="signature-pad-container" id="hr_signature_container">
                <canvas id="hr_signature_pad" class="signature-pad"></canvas>
                <div class="signature-controls">
                  <button type="button" id="clear_hr" class="signature-btn clear">ล้าง</button>
                  <button type="button" id="save_hr" class="signature-btn save">บันทึก</button>
                </div>
                <div class="signature-status" id="hr_status">กรุณาเซ็นชื่อที่นี่</div>
                <div class="signature-quality-notice">เซ็นชื่อให้มีขนาดใหญ่และชัดเจน</div>
              </div>
            </div>
          </div>
        </div>
        <div class="note-box">
          <p class="font-medium mb-1">หมายเหตุ</p>
          <p>กรุณาเซ็นชื่อในช่องลายเซ็นแล้วกดบันทึกก่อนดาวน์โหลดเอกสาร PDF</p>
        </div>
        <div class="btn-group">
          <button type="button" id="btnPreview" class="btn btn-primary flex-1 md:flex-none">อัปเดต</button>
          <button type="button" id="btnSaveSheet" class="btn btn-primary">บันทึกลง Google Sheet</button>
          <button type="button" id="btnPDF" class="btn btn-secondary flex-1 md:flex-none">ดาวน์โหลด PDF</button>
          <button type="button" id="btnShare" class="btn btn-secondary flex-1 md:flex-none">🌐 สร้างลิงก์แชร์</button>
          <button type="button" id="btnReset" class="btn btn-danger flex-1 md:flex-none">ล้างข้อมูล</button>
        </div>
      </form>
    </div>
    <div class="card">
      <h2 class="section-title">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
        ตัวอย่างเอกสาร
      </h2>
      <div id="contractPreview" class="a4 a4-preview-mode contract-content">
        <div class="content-wrapper"></div>
      </div>
    </div>
  </div>
</div>
<div id="notification" class="notification"></div>
<script>
const $ = id => document.getElementById(id);
function dateTH(d) {
    if (!d) return "........";
    const date = new Date(d);
    if (isNaN(date.getTime())) return "........";
    const thaiMonths = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
    return `${date.getDate()} ${thaiMonths[date.getMonth()]} ${date.getFullYear() + 543}`;
}
function formatDate(d) {
    if (!d) return ".......";
    try {
        const date = new Date(d);
        if (isNaN(date.getTime())) return ".......";
        return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear() + 543}`;
    } catch (e) {
        return ".......";
    }
}
function showNotification(message, type = 'success') {
    const notification = $('notification');
    notification.textContent = message;
    notification.className = `notification ${type} show`;
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}
// 🔑 แก้ไขให้ตรงกับ Web App URL ของคุณหลัง Deploy
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby9FmIw-TdKpcSdz-zSTO_DS5F1YVPeCL99baTFM1KsEMhA_op_1Q-3i0ohaIOy03of/exec";
function getFormData() {
    return {
        doc_date: $("doc_date")?.value || "",
        employee_name: $("employee_name")?.value || "",
        employee_code: $("employee_code")?.value || "",
        position: $("position")?.value || "",
        department: $("department")?.value || "",
        division: $("division")?.value || "",
        rule_section: $("rule_section")?.value || "",
        rule_clause: $("rule_clause")?.value || "",
        rule_parentheses: $("rule_parentheses")?.value || "",
        rule_page: $("rule_page")?.value || "",
        place: $("place")?.value || "",
        offense_date: $("offense_date")?.value || "",
        offense_description: $("offense_description")?.value || "",
        punishment_type: $("punishment_type")?.value || "",
        suspension_days: $("suspension_days")?.value || "",
        suspension_start: $("suspension_start")?.value || "",
        suspension_end: $("suspension_end")?.value || "",
        termination_date: $("termination_date")?.value || "",
        punishment_detail: $("punishment_detail")?.value || "",
        supervisor_name: $("supervisor_name")?.value || "",
        manager_name: $("manager_name")?.value || "",
        hr_name: $("hr_name")?.value || "",
        signatures: {
            supervisor: window.signatureManager.getSignatureData('supervisor'),
            manager: window.signatureManager.getSignatureData('manager'),
            employee: window.signatureManager.getSignatureData('employee'),
            hr: window.signatureManager.getSignatureData('hr')
        }
    };
}
function validateForm() {
    const requiredFields = [
        "doc_date", "employee_name", "employee_code", "position",
        "department", "division", "place", "offense_date",
        "offense_description", "punishment_type"
    ];
    const missingFields = [];
    requiredFields.forEach(field => {
        if (!$(field).value.trim()) {
            missingFields.push(field);
            $(field).style.borderColor = '#dc2626';
        } else {
            $(field).style.borderColor = '#cbd5e1';
        }
    });
    const punishmentType = $("punishment_type").value;
    if (punishmentType === "พักงาน") {
        if (!$("suspension_days").value.trim()) {
            missingFields.push("suspension_days");
            $("suspension_days").style.borderColor = '#dc2626';
        } else {
            $("suspension_days").style.borderColor = '#cbd5e1';
        }
        if (!$("suspension_start").value.trim()) {
            missingFields.push("suspension_start");
            $("suspension_start").style.borderColor = '#dc2626';
        } else {
            $("suspension_start").style.borderColor = '#cbd5e1';
        }
        if (!$("suspension_end").value.trim()) {
            missingFields.push("suspension_end");
            $("suspension_end").style.borderColor = '#dc2626';
        } else {
            $("suspension_end").style.borderColor = '#cbd5e1';
        }
    } else if (punishmentType === "เลิกจ้าง") {
        if (!$("termination_date").value.trim()) {
            missingFields.push("termination_date");
            $("termination_date").style.borderColor = '#dc2626';
        } else {
            $("termination_date").style.borderColor = '#cbd5e1';
        }
    }
    if (missingFields.length > 0) {
        showNotification('กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
        return false;
    }
    return true;
}
function renderContract() {
    const d = getFormData();
    let suspensionText = "พักงาน เป็นระยะเวลา .... วัน โดยไม่ได้รับค่าจ้าง (ไม่เกิน 7 วัน) เริ่ม ....... ถึง .......";
    let terminationText = "เลิกจ้าง โดยมีผลตั้งแต่วันที่ .......";
    if (d.punishment_type === "พักงาน") {
        const days = d.suspension_days ? d.suspension_days : "....";
        const start = d.suspension_start ? formatDate(d.suspension_start) : ".......";
        const end = d.suspension_end ? formatDate(d.suspension_end) : ".......";
        suspensionText = `พักงาน เป็นระยะเวลา ${days} วัน โดยไม่ได้รับค่าจ้าง (ไม่เกิน 7 วัน) เริ่ม ${start} ถึง ${end}`;
    }
    if (d.punishment_type === "เลิกจ้าง") {
        const termination = d.termination_date ? formatDate(d.termination_date) : ".......";
        terminationText = `เลิกจ้าง โดยมีผลตั้งแต่วันที่ ${termination}`;
    }
    const today = new Date();
    const signatureDate = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear() + 543}`;
    const preview = $("contractPreview");
    if (preview) {
        const contentWrapper = preview.querySelector('.content-wrapper');
        if (contentWrapper) {
            contentWrapper.innerHTML = `
                <div class="government-letter">
                    <div class="letter-header">
                        <div class="letter-title">บันทึกการลงโทษทางวินัย</div>
                    </div>
                    <div class="letter-date">
                        วันที่ ${dateTH(d.doc_date)}
                    </div>
                        <div class="letter-paragraph" style="text-indent: 1.5em;">
                            เนื่องจาก <span class="font-bold">${d.employee_name || "................"}</span>
                            รหัส <span class="font-bold">${d.employee_code || "........"}</span>
                            ตำแหน่ง <span class="font-bold">${d.position || "........"}</span>
                            หน่วยงาน <span class="font-bold">${d.department || "........"}</span>
                            ฝ่าย <span class="font-bold">${d.division || "........"}</span>
                        </div>
                        <div class="letter-paragraph">
                            ได้กระทำผิดข้อบังคับเกี่ยวกับการทำงานบริษัทฯ หมวดที่ <span class="font-bold">${d.rule_section || "........"}</span>
                            ข้อที่ <span class="font-bold">${d.rule_clause || "........"}</span>
                            วงเล็บที่ <span class="font-bold">${d.rule_parentheses || "........"}</span>
                            หน้า <span class="font-bold">${d.rule_page || "........"}</span>
                        </div>
                        <div class="letter-paragraph">
                            หมวดวินัยและโทษทางวินัย ว่าด้วย <span class="font-bold">${d.offense_description || "........................................"}</span>
                        </div>
                        <div class="letter-paragraph">
                            สถานที่ <span class="font-bold">${d.place || "........"}</span>
                            เมื่อวันที่ <span class="font-bold">${dateTH(d.offense_date)}</span>
                        </div>
                        <div class="letter-paragraph">
                            ซึ่งผลการกระทำดังกล่าว ถือเป็นการกระทำที่ฝ่าฝืนคำสั่งว่าด้วยข้อบังคับเกี่ยวกับการทำงานของบริษัทฯ
                            โดยมีบันทึกการลงโทษทางวินัยฉบับนี้ออกไว้เป็นหลักฐานสำคัญ บริษัทฯ พิจารณาลงโทษทางวินัยท่านในความผิดดังกล่าว คือ
                        </div>
                        <div class="letter-section">
                            <div class="letter-list">
                                <div class="letter-list-item">
                                    <input type="checkbox" id="punish_warn_verbal" class="sr-only" ${d.punishment_type === "เตือนด้วยวาจาบันทึกเป็นหนังสือ" ? "checked" : ""}>
                                    <label for="punish_warn_verbal" class="official-checkbox-label punishment-item-label">
                                        <span class="official-checkbox-indicator"></span>
                                        เตือนด้วยวาจาบันทึกเป็นหนังสือ
                                    </label>
                                </div>
                                <div class="letter-list-item">
                                    <input type="checkbox" id="punish_warn_written" class="sr-only" ${d.punishment_type === "เตือนเป็นลายลักษณ์อักษร" ? "checked" : ""}>
                                    <label for="punish_warn_written" class="official-checkbox-label punishment-item-label">
                                        <span class="official-checkbox-indicator"></span>
                                        เตือนเป็นลายลักษณ์อักษร
                                    </label>
                                </div>
                                <div class="letter-list-item">
                                    <input type="checkbox" id="punish_bonus_cut" class="sr-only" ${d.punishment_type === "ตัดโบนัส/ไม่ปรับเงินประจำปี" ? "checked" : ""}>
                                    <label for="punish_bonus_cut" class="official-checkbox-label punishment-item-label">
                                        <span class="official-checkbox-indicator"></span>
                                        ตัดโบนัส / ไม่ปรับเงินประจำปี
                                    </label>
                                </div>
                                <div class="letter-list-item">
                                    <input type="checkbox" id="punish_suspend" class="sr-only" ${d.punishment_type === "พักงาน" ? "checked" : ""}>
                                    <label for="punish_suspend" class="official-checkbox-label punishment-item-label">
                                        <span class="official-checkbox-indicator"></span>
                                        ${suspensionText}
                                    </label>
                                </div>
                                <div class="letter-list-item">
                                    <input type="checkbox" id="punish_terminate" class="sr-only" ${d.punishment_type === "เลิกจ้าง" ? "checked" : ""}>
                                    <label for="punish_terminate" class="official-checkbox-label punishment-item-label">
                                        <span class="official-checkbox-indicator"></span>
                                        ${terminationText}
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="letter-paragraph">
                            คำแนะนำ (ต้นสังกัด): <span class="font-bold">${d.punishment_detail || ".................................................."}</span>
                        </div>
                        <div class="letter-paragraph">
                            หากท่านกระทำผิดซ้ำ / ฝ่าฝืน / มีเจตนาหลีกเลี่ยงไม่ปฏิบัติตามข้อบังคับเกี่ยวกับการทำงานของบริษัทฯ
                            ไม่ว่ากรณีใดๆ ท่านจะถูกลงโทษตามระเบียบบริษัทฯ ต่อไป
                        </div>
                        <div class="letter-signature-section">
                            <div class="signature-grid">
                                <div class="signature-item">
                                    <div class="signature-box-print ${d.signatures.supervisor ? 'has-signature' : ''}">
                                       ${d.signatures.supervisor ? `<img src="${window.signatureManager.getSignatureDataURL('supervisor')}" alt="ลายเซ็นหัวหน้างาน" style="max-height:70px;"/>` : ''}
                                    </div>
                                    <div class="signature-name"> ลงชื่อ ${d.supervisor_name || "..........................."}</div>
                                    <div class="signature-label">หัวหน้างาน</div>
                                    <div class="signature-date">วันที่ ${signatureDate}</div>
                                </div>
                                <div class="signature-item">
                                    <div class="signature-box-print ${d.signatures.manager ? 'has-signature' : ''}">
                                        ${d.signatures.manager ? `<img src="${window.signatureManager.getSignatureDataURL('manager')}" alt="ลายเซ็นผู้จัดการฝ่าย" style="max-height:70px;"/>` : ''}
                                    </div>
                                    <div class="signature-name"> ลงชื่อ ${d.manager_name || "..........................."}</div>
                                    <div class="signature-label">ผจก./ผช.ผจก.ฝ่าย</div>
                                    <div class="signature-date">วันที่ ${signatureDate}</div>
                                </div>
                            </div>
                            <div class="letter-section-title" style="margin-top: 30px;">รับทราบผลการดำเนินการ</div>
                            <div class="letter-paragraph">
                                ข้าพเจ้า <span class="font-bold">${d.employee_name || "................"}</span>
                                ได้รับทราบคำเตือนเมื่อวันที่ <span class="font-bold">${dateTH(d.doc_date) || "........"}</span>
                                และข้าพเจ้าจะปรับปรุงแก้ไขทันที
                            </div>
                            <div class="letter-paragraph">
                                กรณีข้าพเจ้ากระทำผิดวินัยไม่ว่ากรณีใด ข้าพเจ้ายินดีรับผิดและให้บริษัทฯ
                                ดำเนินการตามระเบียบของบริษัทฯ อีกทั้งข้าพเจ้าจะไม่เรียกร้องสิทธิใดๆ
                            </div>
                            <div class="signature-grid">
                                <div class="signature-item">
                                    <div class="signature-box-print ${d.signatures.employee ? 'has-signature' : ''}">
                                        ${d.signatures.employee ? `<img src="${window.signatureManager.getSignatureDataURL('employee')}" alt="ลายเซ็นพนักงาน" style="max-height:70px;"/>` : ''}
                                    </div>
                                    <div class="signature-name"> ลงชื่อ ${d.employee_name || "..........................."}</div>
                                    <div class="signature-label">พนักงาน</div>
                                    <div class="signature-date">วันที่ ${signatureDate}</div>
                                </div>
                                <div class="signature-item">
                                    <div class="signature-box-print ${d.signatures.hr ? 'has-signature' : ''}">
                                        ${d.signatures.hr ? `<img src="${window.signatureManager.getSignatureDataURL('hr')}" alt="ลายเซ็นผู้จัดการฝ่าย HR" style="max-height:70px;"/>` : ''}
                                    </div>
                                    <div class="signature-name"> ลงชื่อ ${d.hr_name || "..........................."}</div>
                                    <div class="signature-label">ผจก./ผช.ผจก.ฝ่าย HR</div>
                                    <div class="signature-date">วันที่ ${signatureDate}</div>
                                </div>
                            </div>
                        </div>
                        <div class="official-advice">
                            <div class="official-advice-title">ข้อแนะนำ</div>
                            <div class="advice-list">
                                <div class="official-advice-item">1. กรณีพนักงานกระทำผิดระเบียบข้อบังคับเกี่ยวกับการทำงานของบริษัทฯ ให้ระบุวินัยให้ชัดเจน</div>
                                <div class="official-advice-item">2. การตักเตือนเป็นลายลักษณ์อักษรไว้แล้ว หากมีการกระทำผิดในความผิดเรื่องเดิม มีผลให้เลิกจ้างโดยไม่จ่ายค่าชดเชยใดๆ ทั้งสิ้น</div>
                                <div class="official-advice-item">3. ใบเตือนทุกกรณีมีผล 1 ปี นับตั้งแต่วันที่กระทำผิด</div>
                                <div class="official-advice-item">4. กรณีเกิดข้อพิพาท ให้มีเอกสารบันทึกการสอบสวนประกอบด้วย</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    }
}
async function downloadPDF() {
    const btnPDF = $("btnPDF");
    btnPDF.disabled = true;
    btnPDF.innerHTML = '<span class="spinner"></span> กำลังสร้าง PDF...';
    try {
        // 1. สร้าง clone ของ preview
        const originalPreview = $("contractPreview");
        const clone = originalPreview.cloneNode(true);
        clone.id = "pdf-clone";
        // 2. ตั้งค่าขนาด A4 เป็นพิกเซล (210mm x 297mm @ 96 DPI ≈ 794 x 1123 px)
        const a4WidthPx = 794;
        const a4HeightPx = 1123;
        const paddingPx = 57; // ~15mm
        clone.style.position = "absolute";
        clone.style.left = "-9999px";
        clone.style.top = "0";
        clone.style.width = `${a4WidthPx}px`;
        clone.style.minHeight = "auto";
        clone.style.height = "auto";
        clone.style.padding = `${paddingPx}px`;
        clone.style.boxSizing = "border-box";
        clone.style.fontFamily = "'Sarabun', sans-serif";
        clone.style.fontSize = "14px";
        clone.style.lineHeight = "1.6";
        clone.style.color = "#000";
        clone.style.backgroundColor = "#fff";
        clone.style.boxShadow = "none";
        clone.style.margin = "0";
        clone.style.borderRadius = "0";
        clone.style.overflow = "visible";
        document.body.appendChild(clone);
        // 3. รอให้ layout คำนวณเสร็จ
        await new Promise(r => setTimeout(r, 100));
        // 4. จับภาพ
        const canvas = await html2canvas(clone, {
            scale: 2,
            backgroundColor: "#fff",
            useCORS: true,
            logging: false,
            width: a4WidthPx,
            windowWidth: a4WidthPx,
            windowHeight: a4HeightPx,
            scrollY: -window.scrollY // ป้องกัน scroll offset
        });
        document.body.removeChild(clone);
        // 5. ตรวจสอบว่าสูงเกิน A4 หรือไม่ → ถ้าเกิน ให้เตือน
        const contentHeightPx = canvas.height;
        if (contentHeightPx > a4HeightPx) {
            if (!confirm("เนื้อหาของคุณยาวเกินหน้า A4 หนึ่งหน้า\nการบังคับให้อยู่ในหน้าเดียวอาจทำให้ข้อความเล็กลง\nต้องการดำเนินการต่อหรือไม่?")) {
                return;
            }
        }
        // 6. สร้าง PDF แบบ A4 หน้าเดียว
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
        });
        const imgData = canvas.toDataURL('image/png', 1.0);
        const imgWidthMm = 210;
        const imgHeightMm = (contentHeightPx * imgWidthMm) / a4WidthPx;
        // ถ้าสูงเกิน → ย่อ scale ให้พอดีหน้า
        let finalHeight = imgHeightMm;
        let yPos = 0;
        if (imgHeightMm > 297) {
            const scale = 297 / imgHeightMm;
            finalHeight = 297;
            yPos = 0;
        } else {
            yPos = (297 - imgHeightMm) / 2; // จัดกึ่งกลางแนวตั้ง (optional)
        }
        pdf.addImage(imgData, 'PNG', 0, 0, imgWidthMm, finalHeight > 297 ? 297 : finalHeight);
        const employeeName = $("employee_name").value || "ไม่ระบุ";
        pdf.save(`บันทึกการลงโทษ_${employeeName}.pdf`);
        showNotification("ดาวน์โหลด PDF เรียบร้อยแล้ว (1 หน้า)");
    } catch (error) {
        console.error("Error generating PDF:", error);
        showNotification("เกิดข้อผิดพลาดในการสร้าง PDF", "error");
    } finally {
        btnPDF.disabled = false;
        btnPDF.textContent = "ดาวน์โหลด PDF";
    }
}
// ✅ เพิ่มใน DOMContentLoaded เพื่อตั้งค่าเริ่มต้น
document.addEventListener('DOMContentLoaded', function() {
    // ... โค้ดเดิมอื่นๆ ...
    // เพิ่มการตั้งค่าเริ่มต้นให้กับตัวอย่างเอกสาร
    const preview = $("contractPreview");
    if (preview) {
        preview.classList.add('a4-preview-mode');
    }
    renderContract();
});
async function generateShareLink() {
    if (!validateForm()) return;
    const btn = $("btnShare");
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> กำลังสร้างลิงก์...';
    try {
        const data = getFormData();
        const payload = {
            ...data,
            timestamp: new Date().toISOString(),
            formatted_doc_date: dateTH(data.doc_date),
            formatted_offense_date: dateTH(data.offense_date),
            formatted_suspension_start: dateTH(data.suspension_start),
            formatted_suspension_end: dateTH(data.suspension_end),
            formatted_termination_date: dateTH(data.termination_date)
        };
        const res = await fetch(SCRIPT_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        const result = await res.json();
        if (result.success && result.id) {
            const shareUrl = `${window.location.origin}${window.location.pathname}?sheet_id=${result.id}`;
            await navigator.clipboard.writeText(shareUrl);
            showNotification("คัดลอกลิงก์แชร์เรียบร้อย (ใช้ได้ทุกที่!)");
        } else {
            throw new Error(result.message || "ไม่ได้รับ ID");
        }
    } catch (e) {
        console.error(e);
        showNotification("สร้างลิงก์แชร์ล้มเหลว", 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = "🌐 สร้างลิงก์แชร์";
    }
}
async function loadFromSheetId(id) {
    try {
        const res = await fetch(`${SCRIPT_URL}?id=${encodeURIComponent(id)}`);
        const data = await res.json();
        if (data.success) {
            loadDataToForm(data.payload);
            showNotification("โหลดข้อมูลจาก Google Sheet เรียบร้อย");
        } else {
            throw new Error(data.message || "ไม่พบข้อมูล");
        }
    } catch (e) {
        console.error(e);
        showNotification("โหลดข้อมูลล้มเหลว", 'error');
    }
}
function loadDataToForm(data) {
    ["doc_date","employee_name","employee_code","position","department","division","rule_section","rule_clause","rule_parentheses","rule_page","place","offense_date","offense_description","punishment_type","suspension_days","suspension_start","suspension_end","termination_date","punishment_detail","supervisor_name","manager_name","hr_name"].forEach(k => {
        if ($(k)) $(k).value = data[k] || '';
    });
    if (data.signatures) {
        Object.keys(data.signatures).forEach(k => {
            if (data.signatures[k]) {
                window.signatureManager.loadSignature(k, data.signatures[k]);
                $(`${k}_status`).textContent = "เซ็นเรียบร้อยแล้ว";
                $(`${k}_status`).classList.add('signed');
            } else {
                $(`${k}_status`).textContent = "กรุณาเซ็นชื่อที่นี่";
                $(`${k}_status`).classList.remove('signed');
            }
        });
    }
    handlePunishmentTypeChange();
    renderContract();
}
function handlePunishmentTypeChange() {
    const punishmentType = $("punishment_type").value;
    const suspensionDetails = $("suspensionDetails");
    const terminationDetails = $("terminationDetails");
    suspensionDetails.classList.add('hidden');
    terminationDetails.classList.add('hidden');
    if (punishmentType === "พักงาน") {
        suspensionDetails.classList.remove('hidden');
    } else if (punishmentType === "เลิกจ้าง") {
        terminationDetails.classList.remove('hidden');
    }
    renderContract();
}
function resetForm() {
    if (Object.values(window.signatureManager.getAllSignatures()).some(sig => sig !== null)) {
        if (!confirm('คุณแน่ใจต้องการล้างข้อมูลทั้งหมด รวมถึงลายเซ็นที่บันทึกไว้?')) {
            return;
        }
    }
    $("contractForm").reset();
    window.signatureManager.clearAllSignatures();
    $("suspensionDetails").classList.add('hidden');
    $("terminationDetails").classList.add('hidden');
    renderContract();
    showNotification("ล้างข้อมูลเรียบร้อยแล้ว");
}
class SignatureManager {
    constructor() {
        this.signatures = {
            supervisor: null,
            manager: null,
            employee: null,
            hr: null
        };
        this.signaturePads = {};
        this.statusElements = {};
    }
    initialize() {
        this.setupSignaturePad('supervisor');
        this.setupSignaturePad('manager');
        this.setupSignaturePad('employee');
        this.setupSignaturePad('hr');
    }
    setupSignaturePad(signatureKey) {
        const canvas = $(`${signatureKey}_signature_pad`);
        const saveBtn = $(`save_${signatureKey}`);
        const clearBtn = $(`clear_${signatureKey}`);
        const status = $(`${signatureKey}_status`);
        this.statusElements[signatureKey] = status;
        function resizeCanvas() {
            const container = canvas.parentElement;
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = container.offsetWidth * ratio;
            canvas.height = 150 * ratio;
            canvas.style.width = container.offsetWidth + 'px';
            canvas.style.height = '150px';
            const ctx = canvas.getContext("2d");
            ctx.scale(ratio, ratio);
            ctx.fillStyle = 'rgb(255, 255, 255)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        this.signaturePads[signatureKey] = new SignaturePad(canvas, {
            backgroundColor: 'rgb(255, 255, 255)',
            penColor: 'rgb(0, 0, 0)',
            minWidth: 1.5,
            maxWidth: 2.5,
            throttle: 16
        });
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        clearBtn.addEventListener('click', () => {
            this.signaturePads[signatureKey].clear();
            this.signatures[signatureKey] = null;
            status.textContent = "กรุณาเซ็นชื่อที่นี่";
            status.classList.remove('signed');
            renderContract();
        });
        saveBtn.addEventListener('click', () => {
            if (this.signaturePads[signatureKey].isEmpty()) {
                showNotification(`กรุณาเซ็นชื่อในช่อง ${signatureKey}`, 'error');
                return;
            }
            this.signatures[signatureKey] = this.signaturePads[signatureKey].toData();
            status.textContent = "เซ็นเรียบร้อยแล้ว";
            status.classList.add('signed');
            renderContract();
            showNotification(`${signatureKey === 'supervisor' ? 'หัวหน้างาน' :
                             signatureKey === 'manager' ? 'ผู้จัดการฝ่าย' :
                             signatureKey === 'employee' ? 'พนักงาน' :
                             'ผู้จัดการฝ่าย HR'} บันทึกลายเซ็นเรียบร้อยแล้ว`);
        });
    }
    hasSignature(signatureKey) {
        return this.signatures[signatureKey] !== null && this.signatures[signatureKey] !== undefined;
    }
    getSignatureData(signatureKey) {
        return this.signatures[signatureKey];
    }
    getSignatureDataURL(signatureKey) {
        if (!this.signaturePads[signatureKey] || !this.hasSignature(signatureKey)) {
            return '';
        }
        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        tempCanvas.width = 300 * ratio;
        tempCanvas.height = 150 * ratio;
        tempCtx.scale(ratio, ratio);
        tempCtx.fillStyle = 'rgb(255, 255, 255)';
        tempCtx.fillRect(0, 0, 300, 150);
        const tempPad = new SignaturePad(tempCanvas, {
            backgroundColor: 'rgb(255, 255, 255)',
            penColor: 'rgb(0, 0, 0)'
        });
        tempPad.fromData(this.signatures[signatureKey]);
        return tempCanvas.toDataURL();
    }
    loadSignature(signatureKey, signatureData) {
        if (!this.signaturePads[signatureKey] || !signatureData) {
            return;
        }
        this.signaturePads[signatureKey].fromData(signatureData);
        this.signatures[signatureKey] = signatureData;
    }
    clearSignature(signatureKey) {
        if (this.signaturePads[signatureKey]) {
            this.signaturePads[signatureKey].clear();
            this.signatures[signatureKey] = null;
            if (this.statusElements[signatureKey]) {
                this.statusElements[signatureKey].textContent = "กรุณาเซ็นชื่อที่นี่";
                this.statusElements[signatureKey].classList.remove('signed');
            }
        }
    }
    clearAllSignatures() {
        Object.keys(this.signaturePads).forEach(key => {
            this.clearSignature(key);
        });
    }
    getAllSignatures() {
        return { ...this.signatures };
    }
}
// ✅ แก้ไข: ฟังก์ชันนี้ใช้ใน btnSaveSheet — ต้องรวมชื่อทั้ง 3 ตำแหน่ง
function getFormDataForSheet() {
    const formData = getFormData();
    return {
        timestamp: new Date().toISOString(),
        doc_date: formData.doc_date,
        employee_name: formData.employee_name,
        employee_code: formData.employee_code,
        position: formData.position,
        department: formData.department,
        division: formData.division,
        rule_section: formData.rule_section,
        rule_clause: formData.rule_clause,
        rule_parentheses: formData.rule_parentheses,
        rule_page: formData.rule_page,
        place: formData.place,
        offense_date: formData.offense_date,
        offense_description: formData.offense_description,
        punishment_type: formData.punishment_type,
        suspension_days: formData.suspension_days,
        suspension_start: formData.suspension_start,
        suspension_end: formData.suspension_end,
        termination_date: formData.termination_date,
        punishment_detail: formData.punishment_detail,
        // ✅ เพิ่มชื่อทั้ง 3 ตำแหน่ง
        supervisor_name: formData.supervisor_name,
        manager_name: formData.manager_name,
        hr_name: formData.hr_name,
        formatted_doc_date: dateTH(formData.doc_date),
        formatted_offense_date: dateTH(formData.offense_date),
        formatted_suspension_start: dateTH(formData.suspension_start),
        formatted_suspension_end: dateTH(formData.suspension_end),
        formatted_termination_date: dateTH(formData.termination_date)
    };
}
document.addEventListener('DOMContentLoaded', function() {
    window.signatureManager = new SignatureManager();
    window.signatureManager.initialize();
    const urlParams = new URLSearchParams(window.location.search);
    const sheetId = urlParams.get('sheet_id');
    if (sheetId) {
        loadFromSheetId(sheetId);
    } else {
        renderContract();
    }
    $("btnPreview").addEventListener("click", renderContract);
    $("btnPDF").addEventListener("click", async () => {
        if (!validateForm()) return;
        await downloadPDF();
    });
    $("btnShare").addEventListener("click", () => {
        if (!validateForm()) return;
        generateShareLink();
    });
    $("btnReset").addEventListener("click", resetForm);
    $("punishment_type").addEventListener("change", handlePunishmentTypeChange);
    renderContract();
    if (!$("doc_date").value) {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        $("doc_date").value = `${year}-${month}-${day}`;
    }
});
// ✅ แก้ไข: ใช้ getFormData() + mode: 'cors' เพื่อให้บันทึกจริงได้
document.getElementById("btnSaveSheet").addEventListener("click", async () => {
    if (!validateForm()) return;
    const btn = document.getElementById("btnSaveSheet");
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> กำลังบันทึก...';
    try {
        // ✅ ใช้ getFormData() แทน getFormDataForSheet() เพื่อให้มี signatures
        const fullData = getFormData();
        const response = await fetch(SCRIPT_URL, {
            method: "POST",
            mode: 'no-cors',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(fullData)
        });
        const result = await response.json();
        if (result.success) {
            showNotification("✅ บันทึกข้อมูลลง Google Sheet เรียบร้อยแล้ว");
        }
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
});
</script>
</body>
</html>