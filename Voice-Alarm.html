<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voice Alarm Attendance - ระบบอัปโหลดเสียงเอง</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      /* Light Mode */
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9ff;
      --text-primary: #333333;
      --text-secondary: #4b5563;
      --border-color: #e6e9ff;
      --header-bg: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --card-shadow: 0 4px 15px rgba(79, 70, 229, 0.1);
      --hover-shadow: 0 6px 20px rgba(79, 70, 229, 0.15);
      --warning-bg: #fffbeb;
      --warning-border: #f59e0b;
      --warning-text: #92400e;
      --empty-text: #6b7280;
      --input-bg: #ffffff;
      --input-border: #e5e7eb;
      --file-label-bg: #f3f4f6;
      --file-label-border: #d1d5db;
      --file-label-text: #6b7280;
      --file-label-hover: #e5e7eb;
      --toggle-off: #ccc;
      --toggle-on: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --success-color: #10b981;
      --error-color: #ef4444;
      --info-color: #3b82f6;
      --warning-color: #f59e0b;
      --primary-color: #4f46e5;
      --primary-hover: #4338ca;
      --sound1-color: #8b5cf6;
      --sound2-color: #06b6d4;
    }
    .dark-mode {
      /* Dark Mode */
      --bg-primary: #1e293b;
      --bg-secondary: #1f2937;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --border-color: #334155;
      --header-bg: linear-gradient(135deg, #38bdf8 0%, #06b6d4 100%);
      --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      --hover-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
      --warning-bg: #1e1b0d;
      --warning-border: #d97706;
      --warning-text: #fde68a;
      --empty-text: #94a3b8;
      --input-bg: #1e293b;
      --input-border: #334155;
      --file-label-bg: #334155;
      --file-label-border: #475569;
      --file-label-text: #94a3b8;
      --file-label-hover: #475569;
      --toggle-off: #475569;
      --toggle-on: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --success-color: #34d399;
      --error-color: #f87171;
      --info-color: #60a5fa;
      --warning-color: #fbbf24;
      --primary-color: #818cf8;
      --primary-hover: #6366f1;
      --sound1-color: #a78bfa;
      --sound2-color: #22d3ee;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Sarabun', Tahoma, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: var(--text-primary);
      transition: background 0.3s ease;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: var(--bg-primary);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: all 0.3s ease;
    }
    header {
      background: var(--header-bg);
      padding: 30px;
      text-align: center;
      color: white;
      position: relative;
    }
    .dark-mode-toggle {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(255,255,255,0.2);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      backdrop-filter: blur(5px);
      transition: all 0.3s ease;
    }
    h1 {
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 10px;
    }
    .subtitle {
      font-size: 1.05rem;
      opacity: 0.9;
    }
    .main-content {
      padding: 25px;
    }
    .upload-section {
      background: var(--bg-secondary);
      padding: 20px;
      border-radius: 15px;
      border: 2px solid var(--border-color);
      box-shadow: var(--card-shadow);
      margin-bottom: 25px;
    }
    .file-upload {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }
    .file-input-wrapper input[type="file"] {
      position: absolute;
      left: -9999px;
    }
    .file-label {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px 20px;
      background: var(--file-label-bg);
      color: var(--file-label-text);
      border: 2px dashed var(--file-label-border);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
    }
    .file-label:hover {
      background: var(--file-label-hover);
      border-color: var(--primary-color);
    }
    .file-label i {
      margin-right: 10px;
      color: var(--primary-color);
    }
    .audio-info {
      background: var(--bg-primary);
      padding: 15px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      margin-top: 10px;
      display: none;
    }
    .audio-info.show {
      display: block;
    }
    .schedule-list {
      margin-bottom: 25px;
    }
    .schedule-item {
      background: var(--bg-secondary);
      margin: 15px 0;
      padding: 20px;
      border-radius: 15px;
      border: 2px solid var(--border-color);
      box-shadow: var(--card-shadow);
    }
    .input-row {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
      margin: 10px 0;
      justify-content: space-between;
    }
    label {
      font-weight: 600;
      color: var(--text-secondary);
      min-width: 100px;
    }
    input[type="time"] {
      padding: 10px 14px;
      border: 2px solid var(--input-border);
      border-radius: 10px;
      font-size: 1rem;
      background: var(--input-bg);
      color: var(--text-primary);
      width: 140px;
    }
    select {
      padding: 10px;
      border: 2px solid var(--input-border);
      border-radius: 10px;
      background: var(--input-bg);
      color: var(--text-primary);
      min-width: 160px;
    }
    .btn {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: white;
      text-decoration: none;
      justify-content: center;
    }
    .btn-sm {
      padding: 6px 12px;
      font-size: 0.85rem;
    }
    .btn-add { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .btn-save { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
    .btn-cancel { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); }
    .btn-start { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
    .btn-del {
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-left: auto;
    }
    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid var(--file-label-bg);
    }
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--empty-text);
    }
    .status-indicator {
      text-align: center;
      margin-top: 15px;
      font-weight: 600;
      color: var(--success-color);
      padding: 10px;
      border-radius: 10px;
      background: rgba(16, 185, 129, 0.1);
    }
    .status-indicator.running {
      color: var(--error-color);
      background: rgba(239, 68, 68, 0.1);
    }

    /* Custom Checkbox with Checkmark */
    .custom-checkbox {
      display: inline-block;
      position: relative;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .custom-checkbox input {
      opacity: 0;
      position: absolute;
      width: 100%;
      height: 100%;
      margin: 0;
      cursor: pointer;
    }

    .checkmark {
      position: absolute;
      top: 0;
      left: 0;
      height: 20px;
      width: 20px;
      background-color: var(--input-bg);
      border: 2px solid var(--input-border);
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .custom-checkbox input:checked ~ .checkmark {
      background-color: var(--success-color);
      border-color: var(--success-color);
    }

    .checkmark:after {
      content: "";
      position: absolute;
      display: none;
      left: 6px;
      top: 2px;
      width: 5px;
      height: 10px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }

    .custom-checkbox input:checked ~ .checkmark:after {
      display: block;
    }

    .current-time {
      text-align: center;
      font-size: 1.2rem;
      margin: 15px 0;
      padding: 10px;
      background: var(--bg-secondary);
      border-radius: 10px;
      border: 1px solid var(--border-color);
    }
    .github-info {
      background: var(--warning-bg);
      border: 1px solid var(--warning-border);
      color: var(--warning-text);
      padding: 15px;
      border-radius: 10px;
      margin-top: 15px;
      font-size: 0.95rem;
    }
    .uploaded-audios {
      margin-top: 20px;
      padding: 15px;
      background: var(--bg-primary);
      border-radius: 10px;
      border: 1px solid var(--border-color);
    }
    .audio-list {
      max-height: 200px;
      overflow-y: auto;
      margin-top: 10px;
    }
    .audio-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid var(--border-color);
    }
    .audio-item:last-child {
      border-bottom: none;
    }
    .audio-item-info {
      flex: 1;
    }
    .audio-item-name {
      font-weight: 600;
    }
    .audio-item-duration {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    .audio-item-actions {
      display: flex;
      gap: 10px;
    }
    .audio-item-play {
      background: var(--success-color);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .audio-item-delete {
      background: var(--error-color);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .sound-slots {
      display: flex;
      gap: 15px;
      margin-top: 15px;
    }
    .sound-slot {
      flex: 1;
      padding: 15px;
      border-radius: 10px;
      border: 2px solid var(--border-color);
      background: var(--bg-primary);
    }
    .sound-slot.active {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
    }
    .sound-slot-1 {
      border-left: 4px solid var(--sound1-color);
    }
    .sound-slot-2 {
      border-left: 4px solid var(--sound2-color);
    }
    .sound-slot-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .sound-slot-title {
      font-weight: 600;
      font-size: 1.1rem;
    }
    .sound-slot-badge {
      background: var(--primary-color);
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
    }
    .sound-slot-content {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .sound-slot-file {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .sound-slot-file-name {
      flex: 1;
      font-size: 0.9rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .sound-slot-empty {
      color: var(--empty-text);
      font-style: italic;
      text-align: center;
      padding: 10px;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      padding: 12px 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      max-width: 300px;
    }
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    @media (max-width: 600px) {
      .input-row {
        flex-direction: column;
        align-items: stretch;
      }
      label {
        min-width: auto;
      }
      .action-buttons .btn {
        width: 100%;
      }
      .file-label {
        padding: 15px;
      }
      .sound-slots {
        flex-direction: column;
      }
      .btn-del {
        margin-left: 0;
        margin-top: 10px;
      }
    }
  </style>
</head>
<body> 
  <div class="container">
    <header>
      <button class="dark-mode-toggle" id="darkModeToggle">🌙</button>
      <h1>⏰ ระบบตั้งเวลาเสียง - อัปโหลดเสียงเอง</h1>
      <p class="subtitle">อัปโหลดเสียง → ตั้งเวลา → เริ่มระบบ</p>
    </header>
    <div class="main-content">
      <div class="current-time" id="current-time">
        <i class="fas fa-clock"></i> เวลาปัจจุบัน: <span id="time-display">กำลังโหลด...</span>
      </div>

      <!-- Audio Upload Section -->
      <div class="upload-section">
        <h3><i class="fas fa-music"></i> อัปโหลดไฟล์เสียงของคุณ</h3>
        <p>รองรับไฟล์ MP3, WAV (ความยาวประมาณ 2 นาที)</p>
        
        <div class="file-upload">
          <div class="file-input-wrapper">
            <input type="file" id="audioFile" accept="audio/mp3,audio/wav,audio/mpeg">
            <label for="audioFile" class="file-label" id="fileLabel">
              <i class="fas fa-cloud-upload-alt"></i> เลือกไฟล์เสียงสำหรับ Slot 1
            </label>
          </div>
          
          <div class="audio-info" id="audioInfo">
            <p><strong>ชื่อไฟล์:</strong> <span id="fileName">-</span></p>
            <p><strong>ขนาด:</strong> <span id="fileSize">-</span></p>
            <p><strong>ประเภท:</strong> <span id="fileType">-</span></p>
            <p><strong>ระยะเวลา:</strong> <span id="fileDuration">-</span></p>
            <div class="github-info">
              <i class="fas fa-info-circle"></i> ไฟล์จะถูกเก็บไว้ในเบราว์เซอร์ของคุณ (ไม่ส่งไปเซิร์ฟเวอร์)
            </div>
          </div>
        </div>
        
        <!-- Sound Slots -->
        <div class="sound-slots">
          <div class="sound-slot sound-slot-1 active" id="soundSlot1">
            <div class="sound-slot-header">
              <div class="sound-slot-title">เสียงที่ 1</div>
              <button class="btn btn-sm" onclick="selectSoundSlot(1)">เลือก</button>
            </div>
            <div class="sound-slot-content">
              <div class="sound-slot-file" id="sound1File">
                <div class="sound-slot-empty" id="sound1Empty">ยังไม่ได้เลือกไฟล์เสียง</div>
              </div>
              <div class="audio-item-actions">
                <button class="audio-item-play" onclick="playSoundSlot(1)">
                  <i class="fas fa-play"></i> ทดสอบเสียง
                </button>
                <button class="audio-item-delete" onclick="clearSoundSlot(1)">
                  <i class="fas fa-trash"></i> ลบเสียง
                </button>
              </div>
            </div>
          </div>
          
          <div class="sound-slot sound-slot-2" id="soundSlot2">
            <div class="sound-slot-header">
              <div class="sound-slot-title">เสียงที่ 2</div>
              <button class="btn btn-sm" onclick="selectSoundSlot(2)">เลือก</button>
            </div>
            <div class="sound-slot-content">
              <div class="sound-slot-file" id="sound2File">
                <div class="sound-slot-empty" id="sound2Empty">ยังไม่ได้เลือกไฟล์เสียง</div>
              </div>
              <div class="audio-item-actions">
                <button class="audio-item-play" onclick="playSoundSlot(2)">
                  <i class="fas fa-play"></i> ทดสอบเสียง
                </button>
                <button class="audio-item-delete" onclick="clearSoundSlot(2)">
                  <i class="fas fa-trash"></i> ลบเสียง
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Schedule List -->
      <div id="schedule-list">
        <div class="empty-state" id="empty-state">
          <h3>ยังไม่มีการตั้งเวลา</h3>
          <p>กดปุ่ม "➕ เพิ่มเวลา" เพื่อเริ่มต้น</p>
        </div>
      </div>

      <div class="status-indicator" id="status-indicator">
        <i class="fas fa-pause-circle"></i> ระบบหยุดอยู่
      </div>

      <div class="action-buttons">
        <button class="btn btn-add" onclick="addSchedule()">
          <i class="fas fa-plus"></i> เพิ่มเวลา
        </button>
        <button class="btn btn-save" onclick="saveSchedules()">
          <i class="fas fa-save"></i> บันทึก
        </button>
        <button class="btn btn-cancel" onclick="clearAll()">
          <i class="fas fa-trash"></i> ลบทั้งหมด
        </button>
        <button class="btn btn-start" id="start-btn" onclick="toggleAlarm()">
          <i class="fas fa-play"></i> เริ่มระบบ
        </button>
      </div>
    </div>

    <!-- Hidden audio element for duration calculation -->
    <audio id="tempAudio" style="display:none;"></audio>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>
  </div>

  <script>
    // Store uploaded audio files
    let uploadedAudios = {
      sound1: null,
      sound2: null
    };
    let schedules = [];
    let isRunning = false;
    let alarmInterval = null;
    let triggeredToday = new Set();
    let preNotified = new Set();
    let audioPlaying = null;
    let currentUploadSlot = 1;
    let lastAlarmTime = '';
    let isAudioPlaying = false;

    // Initialize on DOM load
    document.addEventListener('DOMContentLoaded', () => {
      loadFromStorage();
      updateTime();
      setInterval(updateTime, 1000);
      initDarkMode();
      resetTriggeredAtMidnight();
      document.getElementById('audioFile').addEventListener('change', handleFileUpload);
      selectSoundSlot(1);
      
      // Ensure audio can play by requesting user interaction
      document.body.addEventListener('click', () => {
        // Simple way to ensure audio can play - create and immediately destroy an audio context
        if (typeof AudioContext !== 'undefined') {
          const ctx = new AudioContext();
          ctx.close().catch(() => {});
        }
      }, { once: true });
    });

    function updateTime() {
      const now = new Date();
      document.getElementById('time-display').textContent = now.toLocaleTimeString('th-TH', {
        hour12: false,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    function initDarkMode() {
      try {
        const dark = localStorage.getItem('dark') === 'true';
        if (dark) {
          document.body.classList.add('dark-mode');
          document.getElementById('darkModeToggle').textContent = '☀️';
        }
      } catch (e) {
        // localStorage not available, skip dark mode
      }
    }

    document.getElementById('darkModeToggle').onclick = () => {
      try {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('dark', isDark);
        document.getElementById('darkModeToggle').textContent = isDark ? '☀️' : '🌙';
      } catch (e) {
        // localStorage not available
        document.body.classList.toggle('dark-mode');
        document.getElementById('darkModeToggle').textContent = document.body.classList.contains('dark-mode') ? '☀️' : '🌙';
      }
    };

    function selectSoundSlot(slotNumber) {
      currentUploadSlot = slotNumber;
      document.getElementById('soundSlot1').classList.remove('active');
      document.getElementById('soundSlot2').classList.remove('active');
      document.getElementById(`soundSlot${slotNumber}`).classList.add('active');
      const fileLabel = document.getElementById('fileLabel');
      fileLabel.innerHTML = `<i class="fas fa-cloud-upload-alt"></i> เลือกไฟล์เสียงสำหรับ Slot ${slotNumber}`;
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (!file.type.match('audio.*')) {
        showToast('⚠️ โปรดเลือกไฟล์เสียงเท่านั้น (MP3, WAV)', 'error');
        return;
      }
      
      if (file.size > 10 * 1024 * 1024) {
        showToast('⚠️ ไฟล์ใหญ่เกินไป (สูงสุด 10MB)', 'error');
        return;
      }
      
      const slotKey = `sound${currentUploadSlot}`;
      const oldAudio = uploadedAudios[slotKey];
      if (oldAudio && oldAudio.url?.startsWith('blob:')) {
        URL.revokeObjectURL(oldAudio.url);
      }
      
      const fileUrl = URL.createObjectURL(file);
      
      // อัปเดตกล่องแสดงข้อมูลไฟล์
      document.getElementById('fileName').textContent = file.name;
      document.getElementById('fileSize').textContent = formatFileSize(file.size);
      document.getElementById('fileType').textContent = file.type || 'audio/unknown';
      document.getElementById('fileDuration').textContent = 'กำลังประมวลผล...';
      document.getElementById('audioInfo').classList.add('show');
      
      uploadedAudios[slotKey] = {
        url: fileUrl,
        name: file.name,
        size: formatFileSize(file.size),
        type: file.type,
        duration: 'กำลังประมวลผล...'
      };
      
      const tempAudio = document.getElementById('tempAudio');
      tempAudio.src = fileUrl;
      tempAudio.onloadedmetadata = () => {
        const duration = tempAudio.duration;
        const minutes = Math.floor(duration / 60);
        const seconds = Math.floor(duration % 60);
        const formattedDuration = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        
        uploadedAudios[slotKey].duration = formattedDuration;
        document.getElementById('fileDuration').textContent = formattedDuration;
        updateSoundSlotDisplay(currentUploadSlot);
        
        if (duration > 150) {
          showToast('⚠️ ไฟล์เสียงยาวเกินไป (แนะนำประมาณ 2 นาที)', 'warning');
        }
      };
      
      updateSoundSlotDisplay(currentUploadSlot);
      event.target.value = '';
    }
    
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' bytes';
      else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
      else return (bytes / 1048576).toFixed(1) + ' MB';
    }
    
    function updateSoundSlotDisplay(slotNumber) {
      const slotKey = `sound${slotNumber}`;
      const audio = uploadedAudios[slotKey];
      const slotElement = document.getElementById(`sound${slotNumber}File`);
      const emptyElement = document.getElementById(`sound${slotNumber}Empty`);
      
      if (audio && audio.url) {
        emptyElement.style.display = 'none';
        slotElement.innerHTML = `
          <div class="sound-slot-file-name">${audio.name}</div>
          <div class="audio-item-duration">${audio.duration}</div>
        `;
      } else if (audio && audio.name) {
        emptyElement.style.display = 'none';
        slotElement.innerHTML = `
          <div class="sound-slot-file-name" style="color: var(--warning-color);">
            ⚠️ ${audio.name} (กรุณาอัปโหลดใหม่)
          </div>
          <div class="audio-item-duration">${audio.duration}</div>
        `;
      } else {
        emptyElement.style.display = 'block';
        slotElement.innerHTML = '';
      }
    }
    
    function playSoundSlot(slotNumber) {
      const slotKey = `sound${slotNumber}`;
      const audio = uploadedAudios[slotKey];
      
      if (audio && audio.url) {
        playSound(audio.url);
      } else {
        showToast('⚠️ ไม่มีไฟล์เสียงในช่องนี้ หรือกรุณาอัปโหลดใหม่', 'error');
      }
    }
    
    function clearSoundSlot(slotNumber) {
      const slotKey = `sound${slotNumber}`;
      
      if (uploadedAudios[slotKey]) {
        if (confirm('ลบไฟล์เสียงออกจากช่องนี้?')) {
          if (uploadedAudios[slotKey].url?.startsWith('blob:')) {
            URL.revokeObjectURL(uploadedAudios[slotKey].url);
          }
          uploadedAudios[slotKey] = null;
          updateSoundSlotDisplay(slotNumber);
          
          schedules.forEach(sch => {
            if (sch.sound === slotKey) {
              sch.sound = '';
            }
          });
          refreshScheduleList();
        }
      } else {
        showToast('⚠️ ไม่มีไฟล์เสียงในช่องนี้', 'error');
      }
    }
    
    function refreshScheduleList() {
      const scheduleList = document.getElementById('schedule-list');
      const emptyState = document.getElementById('empty-state');
      
      document.querySelectorAll('.schedule-item').forEach(el => el.remove());
      
      schedules.forEach(sch => {
        addSchedule(sch.time, sch.sound, sch.enabled, sch.repeat, sch.id, true);
      });
      
      if (schedules.length === 0) {
        emptyState.style.display = 'block';
      } else {
        emptyState.style.display = 'none';
      }
    }

    function addSchedule(time = '', sound = '', enabled = true, repeat = 'daily', id = Date.now(), skipPush = false) {
      const soundOptions = getSoundOptions();
      const repeatOptions = [
        { value: 'daily', label: 'ทุกวัน' },
        { value: 'weekdays', label: 'วันทำการ (จ-ศ)' },
        { value: 'custom', label: 'กำหนดเอง...' }
      ];
      
      const item = document.createElement('div');
      item.className = 'schedule-item';
      item.id = 'item-' + id;
      item.innerHTML = `
        <div class="input-row">
          <label>เวลา:</label>
          <input type="time" value="${time}" onchange="updateTimeVal('${id}', this.value)">
        </div>
        <div class="input-row">
          <label>เสียง:</label>
          <select onchange="updateSound('${id}', this.value)">
            ${soundOptions.map(s => `<option value="${s.value}" ${s.value === sound ? 'selected' : ''}>${s.label}</option>`).join('')}
          </select>
        </div>
        <div class="input-row">
          <label>ซ้ำทุก:</label>
          <select onchange="updateRepeat('${id}', this.value)">
            ${repeatOptions.map(r => `<option value="${r.value}" ${r.value === repeat ? 'selected' : ''}>${r.label}</option>`).join('')}
          </select>
        </div>
        <div class="input-row">
          <label>เปิดใช้งาน:</label>
          <label class="custom-checkbox">
            <input type="checkbox" ${enabled ? 'checked' : ''} onchange="updateEnabled('${id}', this.checked)">
            <span class="checkmark"></span>
          </label>
          <button class="btn-del" onclick="removeItem('${id}')">ลบ</button>
        </div>
      `;
      document.getElementById('schedule-list').appendChild(item);
      document.getElementById('empty-state').style.display = 'none';
      
      if (!skipPush) {
        schedules.push({ id, time, sound, enabled, repeat });
      }
    }
    
    function getSoundOptions() {
      const options = [{ value: '', label: '-- เลือกเสียง --' }];
      if (uploadedAudios.sound1 && uploadedAudios.sound1.url) {
        options.push({ value: 'sound1', label: `🔊 เสียงที่ 1: ${uploadedAudios.sound1.name}` });
      } else if (uploadedAudios.sound1) {
        options.push({ value: 'sound1', label: `🔊 เสียงที่ 1: ${uploadedAudios.sound1.name} (กรุณาอัปโหลดใหม่)` });
      }
      
      if (uploadedAudios.sound2 && uploadedAudios.sound2.url) {
        options.push({ value: 'sound2', label: `🔊 เสียงที่ 2: ${uploadedAudios.sound2.name}` });
      } else if (uploadedAudios.sound2) {
        options.push({ value: 'sound2', label: `🔊 เสียงที่ 2: ${uploadedAudios.sound2.name} (กรุณาอัปโหลดใหม่)` });
      }
      return options;
    }

    function updateTimeVal(id, val) { 
      const sch = schedules.find(s => s.id == id); 
      if (sch) sch.time = val; 
    }
    
    function updateSound(id, val) { 
      const sch = schedules.find(s => s.id == id); 
      if (sch) sch.sound = val; 
    }
    
    function updateEnabled(id, val) { 
      const sch = schedules.find(s => s.id == id); 
      if (sch) sch.enabled = val; 
    }
    
    function updateRepeat(id, val) { 
      const sch = schedules.find(s => s.id == id); 
      if (sch) sch.repeat = val; 
    }
    
    function removeItem(id) {
      document.getElementById('item-' + id).remove();
      schedules = schedules.filter(s => s.id != id);
      if (schedules.length === 0) document.getElementById('empty-state').style.display = 'block';
    }

    function saveSchedules() {
      try {
        const schedulesToSave = schedules.map(s => ({ ...s }));
        
        const audiosToSave = {};
        Object.keys(uploadedAudios).forEach(key => {
          const audio = uploadedAudios[key];
          if (audio && audio.name) {
            audiosToSave[key] = {
              name: audio.name,
              size: audio.size,
              type: audio.type,
              duration: audio.duration
            };
          }
        });

        localStorage.setItem('schedules', JSON.stringify(schedulesToSave));
        localStorage.setItem('uploadedAudios', JSON.stringify(audiosToSave));
        
        showToast('✅ บันทึกเรียบร้อย!\nข้อมูลจะไม่หายเมื่อรีเฟรชหน้าเว็บ (แต่ต้องอัปโหลดเสียงใหม่)', 'success');
      } catch (e) {
        showToast('⚠️ ไม่สามารถบันทึกข้อมูลได้', 'error');
      }
    }

    function loadFromStorage() {
      schedules = [];
      const scheduleList = document.getElementById('schedule-list');
      scheduleList.innerHTML = `
        <div class="empty-state" id="empty-state">
          <h3>ยังไม่มีการตั้งเวลา</h3>
          <p>กดปุ่ม "➕ เพิ่มเวลา" เพื่อเริ่มต้น</p>
        </div>
      `;

      try {
        const savedAudios = localStorage.getItem('uploadedAudios');
        if (savedAudios) {
          const audios = JSON.parse(savedAudios);
          Object.keys(audios).forEach(key => {
            if (key === 'sound1' || key === 'sound2') {
              uploadedAudios[key] = {
                name: audios[key].name,
                size: audios[key].size,
                type: audios[key].type,
                duration: audios[key].duration
              };
              updateSoundSlotDisplay(key === 'sound1' ? 1 : 2);
            }
          });
        }

        const savedSchedules = localStorage.getItem('schedules');
        if (savedSchedules) {
          schedules = JSON.parse(savedSchedules);
          document.getElementById('empty-state').style.display = 'none';
          
          schedules.forEach(s => {
            addSchedule(s.time, s.sound, s.enabled, s.repeat, s.id, true);
          });
        }
      } catch (e) {
        // Handle storage errors gracefully
      }
    }

    function isTodayMatchRepeat(repeat) {
      const now = new Date();
      const day = now.getDay();

      switch (repeat) {
        case 'daily':
          return true;
        case 'weekdays':
          return day >= 1 && day <= 5;
        case 'custom':
          return true;
        default:
          return true;
      }
    }

    function playSound(urlOrSlot, volume = 1.0) {
      if (audioPlaying) {
        audioPlaying.pause();
        audioPlaying = null;
      }
      isAudioPlaying = true;

      let url;
      if (urlOrSlot === 'sound1' || urlOrSlot === 'sound2') {
        const audio = uploadedAudios[urlOrSlot];
        if (!audio || !audio.url) {
          showToast(`⚠️ เสียง "${urlOrSlot}" ยังไม่ได้อัปโหลด`, 'error');
          isAudioPlaying = false;
          return;
        }
        url = audio.url;
      } else {
        url = urlOrSlot;
      }
      
      const audio = new Audio(url);
      audio.volume = volume;
      audioPlaying = audio;
      try {
        audio.play().catch(e => {
          console.warn('Audio play failed:', e);
          showToast('⚠️ ไม่สามารถเล่นเสียงได้ (คลิกที่หน้าเว็บก่อน)', 'error');
        });
      } catch (e) {
        console.warn('Audio play failed:', e);
        showToast('⚠️ ไม่สามารถเล่นเสียงได้', 'error');
      }
      
      audio.onended = () => {
        audioPlaying = null;
        isAudioPlaying = false;
      };
    }

    function checkAlarms() {
      const now = new Date();
      const timeStr = now.toTimeString().slice(0, 5);
      const oneMinLater = new Date(now.getTime() + 60000).toTimeString().slice(0, 5);
      const todayStr = now.toDateString();

      if (timeStr === lastAlarmTime) return;
      lastAlarmTime = timeStr;

      // Pre-notification
      schedules.forEach(sch => {
        if (sch.enabled && sch.time === oneMinLater && isTodayMatchRepeat(sch.repeat)) {
          const key = `pre-${sch.id}-${todayStr}`;
          if (!preNotified.has(key)) {
            preNotified.add(key);
            showToast(`🔔 อีก 1 นาทีจะถึงเวลา ${sch.time}`, 'info');
          }
        }
      });

      // Main alarm
      schedules.forEach(sch => {
        if (sch.enabled && sch.time === timeStr && isTodayMatchRepeat(sch.repeat)) {
          const key = `${sch.id}-${todayStr}`;
          if (!triggeredToday.has(key)) {
            triggeredToday.add(key);
            playSound(sch.sound);
            showToast(`🔔 ถึงเวลา ${sch.time} แล้ว!`, 'success');
          }
        }
      });
    }

    function toggleAlarm() {
      if (isRunning) {
        clearInterval(alarmInterval);
        isRunning = false;
        document.getElementById('start-btn').innerHTML = '<i class="fas fa-play"></i> เริ่มระบบ';
        document.getElementById('status-indicator').innerHTML = '<i class="fas fa-pause-circle"></i> ระบบหยุดอยู่';
        document.getElementById('status-indicator').classList.remove('running');
      } else {
        if (!schedules.some(s => s.enabled)) {
          showToast('⚠️ ไม่มีรายการที่เปิดใช้งาน', 'error');
          return;
        }
        
        let missingSound = false;
        for (const sch of schedules) {
          if (sch.enabled && sch.sound) {
            const audio = uploadedAudios[sch.sound];
            if (!audio || !audio.url) {
              missingSound = true;
              break;
            }
          }
        }
        
        if (missingSound) {
          if (!confirm('มีรายการที่ยังไม่ได้อัปโหลดไฟล์เสียง\nระบบจะข้ามรายการเหล่านั้นเมื่อถึงเวลา\nต้องการเริ่มระบบหรือไม่?')) {
            return;
          }
        }

        alarmInterval = setInterval(checkAlarms, 1000);
        isRunning = true;
        document.getElementById('start-btn').innerHTML = '<i class="fas fa-stop"></i> หยุดระบบ';
        document.getElementById('status-indicator').innerHTML = '<i class="fas fa-play-circle"></i> ระบบกำลังทำงาน...';
        document.getElementById('status-indicator').classList.add('running');
      }
    }

    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    function resetAllState() {
      if (isRunning) {
        clearInterval(alarmInterval);
        isRunning = false;
      }
      schedules = [];
      uploadedAudios = { sound1: null, sound2: null };
      triggeredToday.clear();
      preNotified.clear();
      lastAlarmTime = '';
      isAudioPlaying = false;
      if (audioPlaying) {
        audioPlaying.pause();
        audioPlaying = null;
      }
    }

    function clearAll() {
      if (confirm('ลบการตั้งค่าทั้งหมด?')) {
        resetAllState();
        try {
          localStorage.removeItem('schedules');
          localStorage.removeItem('uploadedAudios');
        } catch (e) {
          // Handle storage errors
        }
        
        document.getElementById('schedule-list').innerHTML = `
          <div class="empty-state" id="empty-state">
            <h3>ยังไม่มีการตั้งเวลา</h3>
            <p>กดปุ่ม "➕ เพิ่มเวลา" เพื่อเริ่มต้น</p>
          </div>
        `;
        
        document.getElementById('audioInfo').classList.remove('show');
        document.getElementById('audioFile').value = '';
        updateSoundSlotDisplay(1);
        updateSoundSlotDisplay(2);
        
        document.getElementById('start-btn').innerHTML = '<i class="fas fa-play"></i> เริ่มระบบ';
        document.getElementById('status-indicator').innerHTML = '<i class="fas fa-pause-circle"></i> ระบบหยุดอยู่';
        document.getElementById('status-indicator').classList.remove('running');
        
        selectSoundSlot(1);
        showToast('🗑️ ลบการตั้งค่าทั้งหมดเรียบร้อย!', 'success');
      }
    }

    function resetTriggeredAtMidnight() {
      const now = new Date();
      const msToMidnight = (24 - now.getHours()) * 3600000 - now.getMinutes() * 60000 - now.getSeconds() * 1000 - now.getMilliseconds();
      setTimeout(() => {
        triggeredToday.clear();
        preNotified.clear();
        resetTriggeredAtMidnight();
      }, msToMidnight);
    }

    window.addEventListener('beforeunload', () => {
      if (audioPlaying) audioPlaying.pause();
      if (alarmInterval) clearInterval(alarmInterval);
      
      Object.values(uploadedAudios).forEach(audio => {
        if (audio && audio.url?.startsWith('blob:')) {
          URL.revokeObjectURL(audio.url);
        }
      });
    });
  </script>
</body>
</html>